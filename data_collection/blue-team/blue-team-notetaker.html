<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Simulation | BLUE Team Notes</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        :root {
            /* Refined Color System - Restrained Navy */
            --color-navy: #1a4480;
            --color-navy-muted: #2d5a8a;
            --color-burgundy: #8b1538;
            --color-burgundy-light: #a91d45;
            
            /* Neutral Palette - Dominant */
            --color-bg: #fafafa;
            --color-surface: #ffffff;
            --color-surface-alt: #f5f5f5;
            --color-border: #e0e0e0;
            --color-border-light: #ebebeb;
            --color-text: #1a1a1a;
            --color-text-secondary: #505050;
            --color-text-muted: #888888;
            
            /* Subtle Accents */
            --color-success: #2e7d5a;
            --color-warning: #b8860b;
            --color-alert: #c23b22;
            
            /* Typography */
            --font-serif: 'Libre Baskerville', Georgia, 'Times New Roman', serif;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
            
            /* Spacing */
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 48px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-elegant: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-sans);
            font-size: 1rem;
            line-height: 1.6;
            background: var(--color-bg);
            color: var(--color-text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header Bar - Refined and Minimal */
        .header {
            background: var(--color-surface);
            color: var(--color-text);
            padding: var(--space-sm) var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            position: relative;
            z-index: 100;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .brand-mark {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: inherit;
        }

        .brand-mark svg {
            width: 100%;
            height: 100%;
        }

        .header-title h1 {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--color-text);
            letter-spacing: 0.01em;
            margin-bottom: 1px;
        }

        .header-title p {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            letter-spacing: 0.03em;
        }

        .header-controls {
            display: flex;
            gap: var(--space-lg);
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: var(--space-xs);
            align-items: center;
        }

        .control-label {
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        /* Move Selector */
        .move-selector {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            letter-spacing: 0.03em;
        }

        .move-selector:hover {
            border-color: var(--color-text-muted);
        }

        .move-selector:focus {
            outline: none;
            border-color: var(--color-burgundy);
            box-shadow: 0 0 0 2px rgba(139, 21, 56, 0.1);
        }

        /* Phase Buttons */
        .phase-btn {
            padding: 6px 10px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            cursor: pointer;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            min-width: 32px;
            text-align: center;
        }

        .phase-btn:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .phase-btn.active {
            background: var(--color-navy);
            color: white;
            border-color: var(--color-navy);
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar - Light and Clean */
        .sidebar {
            width: 260px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            overflow-y: auto;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .section-nav {
            padding: var(--space-md) var(--space-sm);
            flex: 1;
        }

        .nav-section-label {
            font-family: var(--font-mono);
            font-size: 0.5625rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--color-text-muted);
            padding: 0 var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .nav-item {
            padding: 12px var(--space-sm);
            margin-bottom: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-smooth);
            border-radius: 6px;
            position: relative;
        }

        .nav-item:hover {
            background: var(--color-surface-alt);
        }

        .nav-item.active {
            background: var(--color-surface-alt);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: var(--color-navy);
            border-radius: 0 2px 2px 0;
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
        }

        .nav-icon svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        .nav-item.active .nav-icon {
            color: var(--color-navy);
        }

        .nav-content {
            flex: 1;
        }

        .nav-title {
            font-weight: 500;
            font-size: 0.8125rem;
            color: var(--color-text);
            letter-spacing: 0.01em;
        }

        .nav-item.active .nav-title {
            font-weight: 600;
        }

        .nav-subtitle {
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            margin-top: 1px;
        }

        .nav-badge {
            background: var(--color-surface-alt);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            font-size: 0.625rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
            border: 1px solid var(--color-border);
        }

        .nav-item.active .nav-badge {
            background: var(--color-navy);
            color: white;
            border-color: var(--color-navy);
        }

        /* Sidebar Timer */
        .sidebar-timer {
            padding: var(--space-md);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface-alt);
            text-align: center;
        }

        .timer-label {
            font-family: var(--font-mono);
            font-size: 0.5625rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--color-text-muted);
            margin-bottom: var(--space-xs);
        }

        .timer {
            font-size: 2.25rem;
            font-weight: 600;
            font-family: var(--font-mono);
            color: var(--color-text);
            letter-spacing: 0.03em;
        }

        .timer.warning { 
            color: var(--color-warning); 
        }
        
        .timer.critical { 
            color: var(--color-alert); 
            animation: timerPulse 1s ease-in-out infinite; 
        }

        @keyframes timerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timer-controls {
            display: flex;
            gap: 6px;
            margin-top: var(--space-sm);
            justify-content: center;
        }

        .timer-btn {
            padding: 6px 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            cursor: pointer;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all var(--transition-fast);
        }

        .timer-btn:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        /* Sidebar Actions */
        .sidebar-actions {
            padding: var(--space-sm);
            border-top: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .sidebar-actions .btn {
            width: 100%;
            justify-content: center;
            font-size: 0.6875rem;
            padding: 10px 12px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg) var(--space-xl);
            background: var(--color-bg);
        }

        .section-content {
            display: none;
            max-width: 860px;
            margin: 0 auto;
            opacity: 0;
            transform: translateY(8px);
        }

        .section-content.active {
            display: block;
            animation: sectionFadeIn 0.35s var(--transition-elegant) forwards;
        }

        @keyframes sectionFadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-border);
        }

        .section-header h2 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 4px;
            letter-spacing: 0.01em;
        }

        .section-header p {
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }

        /* Phase Guidance */
        .phase-guidance {
            background: var(--color-surface);
            border-left: 3px solid var(--color-navy);
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            border-radius: 0 6px 6px 0;
        }

        .phase-guidance strong {
            display: block;
            margin-bottom: 4px;
            font-family: var(--font-mono);
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-navy);
        }

        /* Cards */
        .note-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 8px;
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            transition: all var(--transition-smooth);
        }

        .note-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .note-card h3 {
            font-family: var(--font-sans);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--color-border-light);
        }

        .card-icon {
            width: 22px;
            height: 22px;
            background: var(--color-surface-alt);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-border);
        }

        .card-icon svg {
            width: 12px;
            height: 12px;
            stroke: var(--color-text-muted);
            stroke-width: 2;
            fill: none;
        }

        /* Quick Capture Section */
        .quick-capture-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .quick-capture-title {
            font-family: var(--font-serif);
            font-size: 0.9375rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
            color: var(--color-text);
        }

        .capture-type-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: var(--space-sm);
            flex-wrap: wrap;
        }

        .capture-tab {
            padding: 8px 14px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .capture-tab:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .capture-tab.active {
            background: var(--color-navy);
            color: white;
            border-color: var(--color-navy);
        }

        .capture-section-label {
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .quick-textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.9375rem;
            font-family: var(--font-sans);
            min-height: 120px;
            background: var(--color-surface);
            color: var(--color-text);
            line-height: 1.6;
            transition: all var(--transition-fast);
            resize: vertical;
        }

        .quick-textarea:focus {
            outline: none;
            border-color: var(--color-text-muted);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.03);
        }

        .quick-textarea::placeholder {
            color: var(--color-text-muted);
        }

        .capture-hint {
            font-size: 0.8125rem;
            color: var(--color-text-muted);
            margin-top: 8px;
            font-style: italic;
        }

        .quick-add-btn {
            margin-top: var(--space-sm);
            padding: 12px 24px;
            background: var(--color-navy);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8125rem;
            font-family: var(--font-sans);
            letter-spacing: 0.02em;
            transition: all var(--transition-fast);
        }

        .quick-add-btn:hover {
            background: var(--color-navy-muted);
            transform: translateY(-1px);
        }

        .quick-add-btn:active {
            transform: translateY(0);
        }

        /* Quick Buttons */
        .quick-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .quick-btn {
            padding: 8px 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-secondary);
        }

        .quick-btn:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .quick-btn.selected {
            background: var(--color-text);
            border-color: var(--color-text);
            color: white;
        }

        .faction-tag.selected {
            background: var(--color-navy-muted);
            border-color: var(--color-navy-muted);
            color: white;
        }

        /* Form Elements */
        .form-field {
            margin-bottom: var(--space-md);
        }

        .form-actions {
            margin-top: var(--space-lg);
            padding-top: var(--space-md);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: center;
        }

        .form-label {
            display: block;
            font-weight: 500;
            font-size: 0.8125rem;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.9375rem;
            font-family: var(--font-sans);
            background: var(--color-surface);
            color: var(--color-text);
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-text-muted);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.03);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.6;
        }

        /* Scale Slider */
        .scale-group {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-top: 8px;
        }

        .scale-label {
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            min-width: 70px;
        }

        .scale-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--color-border);
            border-radius: 2px;
            outline: none;
        }

        .scale-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--color-text);
            cursor: pointer;
            border-radius: 4px;
            transition: all var(--transition-fast);
        }

        .scale-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .scale-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--color-text);
            cursor: pointer;
            border-radius: 4px;
            border: none;
        }

        .scale-value {
            min-width: 36px;
            text-align: center;
            font-weight: 600;
            font-family: var(--font-mono);
            color: var(--color-text);
            font-size: 1rem;
        }

        /* Time Grid */
        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-sm);
            margin-top: var(--space-xs);
        }

        .time-box {
            background: var(--color-surface-alt);
            padding: var(--space-sm);
            border: 1px solid var(--color-border-light);
            border-radius: 6px;
            text-align: center;
            transition: all var(--transition-fast);
        }

        .time-box:hover {
            border-color: var(--color-border);
        }

        .time-box label {
            display: block;
            font-family: var(--font-mono);
            font-size: 0.5625rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--color-text-muted);
            margin-bottom: 8px;
        }

        .time-box input {
            width: 70px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            font-family: var(--font-mono);
            border: none;
            background: transparent;
            color: var(--color-text);
        }

        .time-box input:focus {
            outline: none;
        }

        .time-unit {
            font-size: 0.5625rem;
            font-family: var(--font-mono);
            color: var(--color-text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        /* Timeline */
        .timeline {
            max-height: 500px;
            overflow-y: auto;
        }

        .timeline-item {
            padding: var(--space-sm) var(--space-md);
            border-left: 2px solid var(--color-border);
            background: var(--color-surface);
            margin-bottom: 10px;
            border-radius: 0 6px 6px 0;
            transition: all var(--transition-smooth);
        }

        .timeline-item:hover {
            border-left-color: var(--color-text-muted);
        }

        .timeline-item.note {
            border-left-color: var(--color-border);
        }

        .timeline-item.moment {
            border-left-color: var(--color-navy);
        }

        .timeline-item.quote {
            border-left-color: var(--color-navy-muted);
        }

        .timeline-item.analysis {
            border-left-color: var(--color-navy-muted);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .timeline-time {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .timeline-type {
            font-family: var(--font-mono);
            font-size: 0.5625rem;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .timeline-type.note {
            background: var(--color-surface-alt);
            color: var(--color-text-muted);
            border: 1px solid var(--color-border);
        }

        .timeline-type.moment {
            background: var(--color-navy);
            color: white;
        }

        .timeline-type.quote {
            background: var(--color-navy-muted);
            color: white;
        }

        .timeline-type.analysis {
            background: var(--color-navy-muted);
            color: white;
        }

        .timeline-content {
            font-size: 0.9375rem;
            color: var(--color-text);
            line-height: 1.6;
        }

        /* Action List */
        .action-item {
            background: var(--color-surface);
            padding: var(--space-sm);
            margin-bottom: var(--space-xs);
            border: 1px solid var(--color-border-light);
            border-radius: 6px;
            transition: all var(--transition-fast);
        }

        .action-item:hover {
            border-color: var(--color-border);
        }

        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xs);
        }

        .action-number {
            font-weight: 600;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--color-text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            font-family: var(--font-sans);
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-text);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-text-secondary);
        }

        .btn-secondary {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .btn-success {
            background: var(--color-navy);
            color: white;
        }

        .btn-success:hover {
            background: var(--color-navy-muted);
        }

        /* Alert */
        .alert {
            padding: 14px var(--space-md);
            margin-bottom: var(--space-md);
            font-size: 0.8125rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 6px;
            color: var(--color-text-secondary);
        }

        .alert-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            color: var(--color-text-muted);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--color-text-muted);
        }

        .empty-state-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto var(--space-sm);
            opacity: 0.3;
            color: var(--color-text-muted);
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        .empty-state p:last-child {
            font-size: 0.75rem;
            margin-top: 6px;
            opacity: 0.7;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }

            .content-area {
                padding: var(--space-md);
            }

            .section-header h2 {
                font-size: 1.25rem;
            }
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
        }

        @media (max-width: 640px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Loader */
        #loader {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #FAFBFC 0%, #F5F7FA 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-globe {
            position: relative;
            width: 72px;
            height: 72px;
        }

        .loader-globe svg {
            width: 100%;
            height: 100%;
            animation: pulse-globe 2.4s ease-in-out infinite;
        }

        .loader-ring {
            position: absolute;
            inset: -12px;
            border: 1.5px solid transparent;
            border-top-color: var(--color-navy);
            border-radius: 50%;
            animation: spin 1.4s linear infinite;
        }

        .loader-ring::before {
            content: '';
            position: absolute;
            inset: 6px;
            border: 1.5px solid transparent;
            border-top-color: var(--color-navy-muted);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }

        .loader-text {
            margin-top: 28px;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--color-navy);
            opacity: 0.7;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse-globe {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }
    </style>
</head>
<body>
    <div id="loader" aria-label="Loading simulation environment">
        <div class="loader-globe">
            <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.2"/>
                <ellipse cx="24" cy="24" rx="22" ry="10" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.3"/>
                <ellipse cx="24" cy="24" rx="10" ry="22" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.3"/>
                <path d="M2 24h44" stroke="currentColor" stroke-width="1.5" opacity="0.25"/>
                <path d="M24 2v44" stroke="currentColor" stroke-width="1.5" opacity="0.25"/>
                <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
            <div class="loader-ring"></div>
        </div>
    </div>
    <!-- Header -->
    <div class="header">
        <div class="header-brand">
            <a href="../../index.html" class="brand-mark">
                <svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                    <ellipse cx="25" cy="25" rx="23" ry="23" fill="none" stroke="#1a4480" stroke-width="1.5"/>
                    <ellipse cx="25" cy="25" rx="23" ry="10" fill="none" stroke="#1a4480" stroke-width="1" opacity="0.6"/>
                    <ellipse cx="25" cy="25" rx="10" ry="23" fill="none" stroke="#1a4480" stroke-width="1" opacity="0.6"/>
                    <ellipse cx="25" cy="25" rx="10" ry="23" fill="none" stroke="#1a4480" stroke-width="1" opacity="0.4" transform="rotate(60 25 25)"/>
                    <ellipse cx="25" cy="25" rx="10" ry="23" fill="none" stroke="#1a4480" stroke-width="1" opacity="0.4" transform="rotate(-60 25 25)"/>
                    <line x1="2" y1="25" x2="48" y2="25" stroke="#1a4480" stroke-width="1" opacity="0.4"/>
                </svg>
            </a>
            <div class="header-title">
                <h1>BLUE Team Notetaker</h1>
                <p id="moveEpoch">Move 1: Epoch 1 (2027-2030)</p>
            </div>
        </div>
        
        <div class="header-controls">
            <div class="control-group">
                <span class="control-label">Move:</span>
                <select id="moveSelector" onchange="changeMoveContext()" class="move-selector">
                    <option value="1">Move 1</option>
                    <option value="2">Move 2</option>
                    <option value="3">Move 3</option>
                </select>
            </div>
            <div class="control-group">
                <span class="control-label">Phase:</span>
                <div id="phaseIndicator" style="display: flex; gap: 4px;">
                    <button class="phase-btn active" data-phase="1">1</button>
                    <button class="phase-btn" data-phase="2">2</button>
                    <button class="phase-btn" data-phase="3">3</button>
                    <button class="phase-btn" data-phase="4">4</button>
                    <button class="phase-btn" data-phase="5">5</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="section-nav">
                <div class="nav-section-label">Sections</div>
                
                <div class="nav-item active" data-section="capture">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Quick Capture</div>
                        <div class="nav-subtitle">Live observations</div>
                    </div>
                </div>

                <div class="nav-item" data-section="dynamics">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Team Dynamics</div>
                        <div class="nav-subtitle">Decision process</div>
                    </div>
                </div>

                <div class="nav-item" data-section="alliance">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Alliance Engagement</div>
                        <div class="nav-subtitle">External interactions</div>
                    </div>
                </div>

                <div class="nav-item" data-section="actions">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Actions Decided</div>
                        <div class="nav-subtitle">What BLUE chose</div>
                    </div>
                    <span class="nav-badge" id="actionsBadge">0</span>
                </div>

                <div class="nav-item" data-section="timeline">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Timeline</div>
                        <div class="nav-subtitle">All captured items</div>
                    </div>
                    <span class="nav-badge" id="timelineBadge">0</span>
                </div>
            </div>
            
            <div class="sidebar-actions">
                <button class="btn btn-success" onclick="submitNotes()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    Submit data to WHITE Cell
                </button>
            </div>
            
            <div class="sidebar-timer">
                <div class="timer-label">Time Remaining</div>
                <div class="timer" id="timer">90:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" id="startTimer">Start</button>
                    <button class="timer-btn" id="pauseTimer">Pause</button>
                    <button class="timer-btn" id="resetTimer">Reset</button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Quick Capture Section -->
            <div class="section-content active" id="capture">
                <div class="section-header">
                    <h2>Quick Capture</h2>
                    <p>Document observations from the BLUE Team deliberations in real-time</p>
                </div>

                <div id="phaseGuidanceContainer"></div>

                <div class="quick-capture-section">
                    <div class="quick-capture-title">Observation Entry</div>
                    
                    <div style="margin-bottom: 16px;">
                        <div class="capture-section-label">Classification</div>
                        <div class="capture-type-tabs">
                            <div class="capture-tab active" data-type="note">General Note</div>
                            <div class="capture-tab" data-type="moment">Key Moment</div>
                            <div class="capture-tab" data-type="quote">Notable Quote</div>
                            <div class="capture-tab" data-type="requestinfo">Information Request</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div class="capture-section-label">Speaker (optional)</div>
                        <div class="quick-buttons" id="factionButtons">
                            <button class="quick-btn faction-tag" data-faction="leg">Legislative</button>
                            <button class="quick-btn faction-tag" data-faction="exec">Executive</button>
                            <button class="quick-btn faction-tag" data-faction="vc">Industry/VC</button>
                            <button class="quick-btn faction-tag" data-faction="team">General Team</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div class="capture-section-label">Process Markers (optional)</div>
                        <div class="quick-buttons">
                            <button class="quick-btn debate-marker" data-marker="started">Debate Initiated</button>
                            <button class="quick-btn debate-marker" data-marker="shifted">Topic Shifted</button>
                            <button class="quick-btn debate-marker" data-marker="actions">Action Discussion</button>
                            <button class="quick-btn debate-marker" data-marker="consensus">Consensus Reached</button>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div class="capture-section-label">Quick Templates</div>
                        <div class="quick-buttons">
                            <button class="quick-btn template-btn" onclick="insertTemplate('disagree')">Disagreement</button>
                            <button class="quick-btn template-btn" onclick="insertTemplate('consensus')">Consensus</button>
                            <button class="quick-btn template-btn" onclick="insertTemplate('question')">Question Raised</button>
                            <button class="quick-btn template-btn" onclick="insertTemplate('concern')">Concern Noted</button>
                        </div>
                    </div>

                    <textarea class="quick-textarea" id="quickCaptureText" placeholder="Enter your observation..."></textarea>
                    
                    <div class="capture-hint" id="captureHint">
                        Document discussions, decisions, and notable moments as they occur.
                    </div>

                    <button class="quick-add-btn" onclick="addCapture()">Add to Timeline</button>
                </div>

                <div class="alert alert-info">
                    <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <span><strong>Guidance:</strong> Maintain continuous documentation. Use the navigation panel to organize detailed observations during breaks.</span>
                </div>
            </div>

            <!-- Timeline Section -->
            <div class="section-content" id="timeline">
                <div class="section-header">
                    <h2>Timeline</h2>
                    <p>Chronological record of all documented observations</p>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                        </span>
                        Filter View
                    </h3>
                    <div class="quick-buttons">
                        <button class="quick-btn selected" data-filter="all">All Items</button>
                        <button class="quick-btn" data-filter="note">Notes</button>
                        <button class="quick-btn" data-filter="moment">Key Moments</button>
                        <button class="quick-btn" data-filter="quote">Quotes</button>
                        <button class="quick-btn" data-filter="requestinfo">Info Requests</button>
                        <button class="quick-btn" data-filter="analysis">Analysis</button>
                    </div>
                </div>

                <div class="timeline" id="timelineContainer">
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <p>No observations documented</p>
                        <p>Begin capturing in the Quick Capture section</p>
                    </div>
                </div>
            </div>

            <!-- Team Dynamics Section -->
            <div class="section-content" id="dynamics">
                <div class="section-header">
                    <h2>Team Dynamics</h2>
                    <p>Analysis of internal decision-making processes observed</p>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        </span>
                        Leadership & Decision-Making
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Primary discussion leader</label>
                        <div class="quick-buttons">
                            <button class="quick-btn" data-group="leader" data-value="leg">Legislative</button>
                            <button class="quick-btn" data-group="leader" data-value="exec">Executive</button>
                            <button class="quick-btn" data-group="leader" data-value="vc">Industry/VC</button>
                            <button class="quick-btn" data-group="leader" data-value="balanced">Balanced/Rotated</button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Leadership observations</label>
                        <textarea class="form-textarea" id="leadershipNotes" placeholder="Document who dominated discussions, who remained reserved, who resolved impasses..."></textarea>
                    </div>
                    <div class="grid-2">
                        <div class="form-field">
                            <label class="form-label">Decision methodology</label>
                            <select class="form-select" id="decisionStyle">
                                <option>Unanimous consensus</option>
                                <option>Strong consensus (one dissent)</option>
                                <option>Narrow majority</option>
                                <option>Dictated by leadership</option>
                                <option>Formal vote taken</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label class="form-label">Deliberation vs. execution balance</label>
                            <div class="scale-group">
                                <span class="scale-label">Deliberation</span>
                                <input type="range" class="scale-slider" id="debateVsExecute" min="1" max="10" value="5">
                                <span class="scale-label">Execution</span>
                                <span class="scale-value" id="debateVsExecuteValue">5</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        </span>
                        Time Allocation
                    </h3>
                    <div class="time-grid">
                        <div class="time-box">
                            <label>Internal Discussion</label>
                            <input type="number" id="timeInternal" value="0" min="0">
                            <div class="time-unit">minutes</div>
                        </div>
                        <div class="time-box">
                            <label>Industry/VC Input</label>
                            <input type="number" id="timeIndustry" value="0" min="0">
                            <div class="time-unit">minutes</div>
                        </div>
                        <div class="time-box">
                            <label>GREEN Preparation</label>
                            <input type="number" id="timePrepGreen" value="0" min="0">
                            <div class="time-unit">minutes</div>
                        </div>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </span>
                        Divided Government Dynamics
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Primary points of disagreement</label>
                        <textarea class="form-textarea" id="disagreements" placeholder="Document Legislative-Executive tensions and areas of conflict..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Debate intensity</label>
                        <div class="scale-group">
                            <span class="scale-label">Measured</span>
                            <input type="range" class="scale-slider" id="debateIntensity" min="1" max="10" value="5">
                            <span class="scale-label">Intense</span>
                            <span class="scale-value" id="debateValue">5</span>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Consensus mechanism</label>
                        <textarea class="form-textarea" id="consensus" placeholder="Document how agreements were reached: compromise, concession, third-party mediation..."></textarea>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </span>
                        Strategic Approach
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Strategic posture selected</label>
                        <div class="quick-buttons">
                            <button class="quick-btn" data-group="posture" data-value="offensive">Offensive</button>
                            <button class="quick-btn" data-group="posture" data-value="defensive">Defensive</button>
                            <button class="quick-btn" data-group="posture" data-value="mixed">Mixed</button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Strategic rationale</label>
                        <textarea class="form-textarea" id="postureReason" placeholder="Document the reasoning behind their strategic approach..."></textarea>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                        </span>
                        Assumptions & Priorities
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Key operational assumptions</label>
                        <textarea class="form-textarea" id="keyAssumptions" placeholder="Document assumptions driving their decisions..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Legislative faction priorities</label>
                        <textarea class="form-textarea" id="legislativePriorities" placeholder="Document Legislative faction's primary objectives..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Executive faction priorities</label>
                        <textarea class="form-textarea" id="executivePriorities" placeholder="Document Executive faction's primary objectives..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Industry/VC faction priorities</label>
                        <textarea class="form-textarea" id="industryPriorities" placeholder="Document Industry/VC faction's primary objectives..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Priority conflicts observed</label>
                        <textarea class="form-textarea" id="priorityConflicts" placeholder="Document where priorities clash and trade-offs under debate..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Blind spots or unchallenged assumptions</label>
                        <textarea class="form-textarea" id="blindSpots" placeholder="Document what the team is NOT considering..."></textarea>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                        </span>
                        Resource Management
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Power conservation discussion</label>
                        <div class="quick-buttons">
                            <button class="quick-btn" data-group="powersave" data-value="yes">Conserving Resources</button>
                            <button class="quick-btn" data-group="powersave" data-value="no">Deploying Now</button>
                            <button class="quick-btn" data-group="powersave" data-value="unclear">Not Discussed</button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Resource strategy notes</label>
                        <textarea class="form-textarea" id="powerStrategy" placeholder="Document discussions regarding resource deployment vs. conservation..."></textarea>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
                        </span>
                        Decision Efficiency
                    </h3>
                    <div class="grid-2">
                        <div class="form-field">
                            <label class="form-label">Actions revised/changed</label>
                            <input type="number" class="form-input" id="actionsRevised" placeholder="0" min="0">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Average decision time</label>
                            <select class="form-select" id="decisionSpeed">
                                <option>Very fast (&lt; 5 min)</option>
                                <option>Fast (5-10 min)</option>
                                <option>Moderate (10-20 min)</option>
                                <option>Slow (20-30 min)</option>
                                <option>Very slow (&gt; 30 min)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Time management</label>
                        <div class="quick-buttons">
                            <button class="quick-btn" data-group="time-objective" data-value="yes">On Schedule</button>
                            <button class="quick-btn" data-group="time-objective" data-value="no">Ran Over</button>
                            <button class="quick-btn" data-group="time-objective" data-value="early">Completed Early</button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Efficiency observations</label>
                        <textarea class="form-textarea" id="efficiencyNotes" placeholder="Document factors affecting team efficiency..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-success" onclick="submitTeamDynamics()">Submit Team Dynamics Analysis</button>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="section-content" id="actions">
                <div class="section-header">
                    <h2>Actions Decided</h2>
                    <p>Record of decisions from facilitator and manual documentation</p>
                </div>

                <div class="alert alert-info">
                    <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <span><strong>Note:</strong> Actions submitted through the Facilitator interface will synchronize automatically.</span>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        </span>
                        Facilitator Actions
                    </h3>
                    <div id="facilitatorActions">
                        <div class="empty-state" style="padding: 24px;">
                            <p>No actions submitted via Facilitator</p>
                        </div>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </span>
                        Manual Action Notes
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Additional action observations</label>
                        <textarea class="form-textarea" id="manualActions" placeholder="Document any actions not captured through the facilitator interface..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Alliance Section -->
            <div class="section-content" id="alliance">
                <div class="section-header">
                    <h2>Alliance Engagement</h2>
                    <p>External interactions and responses observed</p>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                        </span>
                        Allied Responses (GREEN)
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Alliance feedback received</label>
                        <textarea class="form-textarea" id="allyFeedback" placeholder="Document alliance responses and feedback conveyed to BLUE..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Impact on BLUE actions</label>
                        <div class="quick-buttons">
                            <button class="quick-btn" data-group="ally-impact" data-value="strengthened">Strengthened position</button>
                            <button class="quick-btn" data-group="ally-impact" data-value="modified">Modified approach</button>
                            <button class="quick-btn" data-group="ally-impact" data-value="minimal">Minimal impact</button>
                            <button class="quick-btn" data-group="ally-impact" data-value="delayed">Delayed decision</button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">BLUE team reaction</label>
                        <textarea class="form-textarea" id="blueReactionAllies" placeholder="Document team's response..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Modifications based on allied input</label>
                        <textarea class="form-textarea" id="allyBasedChanges" placeholder="Document actions modified based on alliance feedback..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Coalition impact assessment</label>
                        <div class="scale-group">
                            <span class="scale-label">Weakened</span>
                            <input type="range" class="scale-slider" id="coalitionImpact" min="1" max="10" value="5">
                            <span class="scale-label">Strengthened</span>
                            <span class="scale-value" id="coalitionImpactValue">5</span>
                        </div>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </span>
                        Adversary Activity (RED Reports)
                    </h3>
                    <div class="form-field">
                        <label class="form-label">PRC/Russia activity reported to BLUE</label>
                        <textarea class="form-textarea" id="redReports" placeholder="Document adversary actions communicated via WHITE Cell..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">BLUE assessment of adversary moves</label>
                        <textarea class="form-textarea" id="blueRedAssessment" placeholder="Document BLUE's interpretation..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Strategy adaptation</label>
                        <div class="quick-buttons">
                            <button class="quick-btn" data-group="red-impact" data-value="yes">Adapted Strategy</button>
                            <button class="quick-btn" data-group="red-impact" data-value="no">Maintained Course</button>
                            <button class="quick-btn" data-group="red-impact" data-value="monitor">Active Monitoring</button>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Counter-measures discussed</label>
                        <textarea class="form-textarea" id="redCounterActions" placeholder="Document proposed responses to adversary actions..."></textarea>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        </span>
                        Adjudication Outcomes
                    </h3>
                    <div class="form-field">
                        <label class="form-label">WHITE Cell feedback</label>
                        <textarea class="form-textarea" id="whiteOutcomes" placeholder="Document outcomes reported by WHITE Cell..."></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">BLUE reaction to outcomes</label>
                        <textarea class="form-textarea" id="blueReactionOutcomes" placeholder="Document team's response..."></textarea>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                        </span>
                        Game State Updates
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Overall game state changes reported</label>
                        <textarea class="form-textarea" id="gameState" placeholder="Document economic indicators, alliance status, power balance updates..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-success" onclick="submitAllianceEngagement()">Submit Alliance Engagement Analysis</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports and local functions
        import { initializeFirebase, saveToFirebase, loadFromFirebase, addToFirebaseCollection, queryFirebaseCollection } from "../../firebase-config.js";

        let db, auth;

        // Initialize Firebase
        initializeFirebase().then(result => {
            if (result) {
                db = result.db;
                auth = result.auth;
                console.log('Firebase initialized in notetaker');
            } else {
                db = null;
                auth = null;
                console.log('Firebase not available, using localStorage only');
            }
            loadData(); // Load data after Firebase check
        }).catch(error => {
            console.error('Firebase initialization failed:', error);
            db = null;
            auth = null;
            loadData(); // Fallback to localStorage
        });

        // Local wrapper functions for Firebase operations
        async function saveToFirebaseLocal(collectionName, docId, data) {
            if (db) {
                return await saveToFirebase(db, collectionName, docId, data);
            } else {
                localStorage.setItem(`${collectionName}_${docId}`, JSON.stringify(data));
                return true;
            }
        }

        async function loadFromFirebaseLocal(collectionName, docId) {
            if (db) {
                return await loadFromFirebase(db, collectionName, docId);
            } else {
                const localData = localStorage.getItem(`${collectionName}_${docId}`);
                return localData ? JSON.parse(localData) : null;
            }
        }

        async function addToFirebaseCollectionLocal(collectionName, data) {
            if (db) {
                return await addToFirebaseCollection(db, collectionName, data);
            } else {
                // For add, just save with a generated id or something, but for simplicity, skip
                console.log('Firebase not available, skipping add to collection');
                return null;
            }
        }

        async function queryFirebaseCollectionLocal(collectionName, conditions = []) {
            if (db) {
                return await queryFirebaseCollection(db, collectionName, conditions);
            } else {
                console.log('Firebase not available, skipping query');
                return [];
            }
        }

        // Move Management
        let currentMove = 1;
        const moveEpochs = {
            1: 'Move 1: Epoch 1 (2027-2030)',
            2: 'Move 2: Epoch 2 (2030-2032)',
            3: 'Move 3: Epoch 3 (2032-2034)'
        };

        async function changeMoveContext() {
            currentMove = parseInt(document.getElementById('moveSelector').value);
            document.getElementById('moveEpoch').textContent = moveEpochs[currentMove];
            
            try {
                const firebaseData = await loadFromFirebaseLocal('notetaker_data', `move_${currentMove}`);
                if (firebaseData) {
                    loadData();
                } else {
                    throw new Error('No Firebase data');
                }
            } catch (error) {
                const currentData = localStorage.getItem(`blueMove${currentMove}`);
                if (currentData) {
                    loadData();
                } else {
                    document.querySelectorAll('input, textarea, select').forEach(el => {
                        if (el.id && el.id !== 'moveSelector') el.value = '';
                    });
                    timelineItems = [];
                    updateTimeline();
                    updateBadges();
                }
            }
            updateActionCount();
        }

        // Phase Management
        let currentPhase = 1;
        let currentFaction = null;

        const phaseGuidance = {
            1: "Phase 1: Internal Deliberation (30-40 min)  Capture Legislative-Executive discussions, Industry/VC input, strategic decisions",
            2: "Phase 2: Alliance Consultation (20-30 min)  You remain in BLUE room. Document available information until team returns with feedback",
            3: "Phase 3: Finalization (10-15 min)  Team reconvenes. Capture final action decisions and last-minute modifications",
            4: "Phase 4: Adjudication (15-20 min)  WHITE Cell processing (team break). Limited documentation expected",
            5: "Phase 5: Results Brief (10-15 min)  Capture WHITE Cell outcomes and BLUE's reaction to results"
        };

        function updatePhaseGuidance() {
            const container = document.getElementById('phaseGuidanceContainer');
            container.innerHTML = `
                <div class="phase-guidance">
                    <strong>Current Phase ${currentPhase}</strong>
                    ${phaseGuidance[currentPhase]}
                </div>
            `;
        }

        document.querySelectorAll('.phase-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.phase-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPhase = parseInt(btn.getAttribute('data-phase'));
                updatePhaseGuidance();
                saveData();
            });
        });

        // Faction tagging
        document.querySelectorAll('.faction-tag').forEach(btn => {
            btn.addEventListener('click', () => {
                const wasSelected = btn.classList.contains('selected');
                document.querySelectorAll('.faction-tag').forEach(b => b.classList.remove('selected'));
                if (!wasSelected) {
                    btn.classList.add('selected');
                    currentFaction = btn.getAttribute('data-faction');
                } else {
                    currentFaction = null;
                }
            });
        });

        // Debate markers
        document.querySelectorAll('.debate-marker').forEach(btn => {
            btn.addEventListener('click', () => {
                const wasSelected = btn.classList.contains('selected');
                document.querySelectorAll('.debate-marker').forEach(b => b.classList.remove('selected'));
                if (!wasSelected) {
                    btn.classList.add('selected');
                }
            });
        });

        // Timer
        let timerSeconds = 90 * 60;
        let timerInterval = null;
        let timerRunning = false;

        function updateTimer() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            timerEl.classList.remove('warning', 'critical');
            if (timerSeconds <= 300 && timerSeconds > 60) {
                timerEl.classList.add('warning');
            } else if (timerSeconds <= 60) {
                timerEl.classList.add('critical');
            }
        }

        document.getElementById('startTimer').addEventListener('click', () => {
            if (!timerRunning) {
                timerRunning = true;
                timerInterval = setInterval(() => {
                    if (timerSeconds > 0) {
                        timerSeconds--;
                        updateTimer();
                    } else {
                        clearInterval(timerInterval);
                        timerRunning = false;
                    }
                }, 1000);
            }
        });

        document.getElementById('pauseTimer').addEventListener('click', () => {
            if (timerRunning) {
                clearInterval(timerInterval);
                timerRunning = false;
            }
        });

        document.getElementById('resetTimer').addEventListener('click', () => {
            clearInterval(timerInterval);
            timerRunning = false;
            timerSeconds = 90 * 60;
            updateTimer();
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                const sectionId = item.getAttribute('data-section');
                document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
            });
        });

        // Capture Types
        const captureTypes = {
            note: 'General observations, team discussions, decisions being made...',
            moment: 'Significant turning point: decision made, position changed, consensus reached...',
            quote: 'Notable statement or memorable phrasing from a participant...',
            requestinfo: 'Team requesting information from WHITE Cell or observers...'
        };

        document.querySelectorAll('.capture-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.capture-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('captureHint').textContent = captureTypes[tab.getAttribute('data-type')];
            });
        });

        // Templates
        function insertTemplate(type) {
            const templates = {
                disagree: '[DISAGREEMENT] Between ___ and ___ regarding: ',
                consensus: '[CONSENSUS] Team agreed on: ',
                question: '[QUESTION RAISED] ___ asked: ',
                concern: '[CONCERN] ___ expressed concern about: '
            };
            document.getElementById('quickCaptureText').value += templates[type];
            document.getElementById('quickCaptureText').focus();
        }

        // Timeline Management
        let timelineItems = [];

        function addCapture() {
            const text = document.getElementById('quickCaptureText').value.trim();
            if (!text) return;

            const activeType = document.querySelector('.capture-tab.active');
            const type = activeType ? activeType.getAttribute('data-type') : 'note';
            
            const selectedMarker = document.querySelector('.debate-marker.selected');
            const marker = selectedMarker ? selectedMarker.getAttribute('data-marker') : null;

            const item = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                phase: currentPhase,
                type: type,
                content: text,
                faction: currentFaction,
                marker: marker
            };

            timelineItems.unshift(item);
            updateTimeline();
            updateBadges();
            saveData();

            document.getElementById('quickCaptureText').value = '';
            document.querySelectorAll('.faction-tag').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.debate-marker').forEach(b => b.classList.remove('selected'));
            currentFaction = null;
        }

        function addAnalysisToTimeline(section) {
            const sectionNames = {
                dynamics: 'Team Dynamics',
                alliance: 'Alliance Engagement'
            };
            
            const item = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                phase: currentPhase,
                type: 'analysis',
                content: `${sectionNames[section]} analysis updated`,
                faction: null,
                marker: null
            };

            timelineItems.unshift(item);
            updateTimeline();
            updateBadges();
            saveData();
        }

        function updateTimeline() {
            const container = document.getElementById('timelineContainer');
            if (timelineItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <p>No observations documented</p>
                        <p>Begin capturing in the Quick Capture section</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = timelineItems.map(item => `
                <div class="timeline-item ${item.type}">
                    <div class="timeline-header">
                        <span class="timeline-time">Phase ${item.phase} | ${item.time}${item.faction ? ' | ' + item.faction.toUpperCase() : ''}</span>
                        <span class="timeline-type ${item.type}">${item.type === 'requestinfo' ? 'Info Request' : item.type === 'analysis' ? 'Analysis' : item.type.charAt(0).toUpperCase() + item.type.slice(1)}</span>
                    </div>
                    <div class="timeline-content">${item.content}</div>
                </div>
            `).join('');
        }

        // Timeline Filtering
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                
                const filter = btn.getAttribute('data-filter');
                const items = document.querySelectorAll('.timeline-item');
                items.forEach(item => {
                    if (filter === 'all' || item.classList.contains(filter)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });

        // Quick buttons for forms
        document.querySelectorAll('.quick-btn[data-group]').forEach(btn => {
            btn.addEventListener('click', () => {
                const group = btn.getAttribute('data-group');
                document.querySelectorAll(`.quick-btn[data-group="${group}"]`).forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            });
        });

        // Scale sliders
        document.getElementById('debateVsExecute').addEventListener('input', (e) => {
            document.getElementById('debateVsExecuteValue').textContent = e.target.value;
        });

        document.getElementById('debateIntensity').addEventListener('input', (e) => {
            document.getElementById('debateValue').textContent = e.target.value;
        });

        document.getElementById('coalitionImpact').addEventListener('input', (e) => {
            document.getElementById('coalitionImpactValue').textContent = e.target.value;
        });

        // Analysis section auto-save and timeline updates
        document.querySelectorAll('#dynamics input, #dynamics textarea, #dynamics select').forEach(el => {
            el.addEventListener('change', () => {
                saveData();
                addAnalysisToTimeline('dynamics');
            });
        });

        document.querySelectorAll('#alliance input, #alliance textarea, #alliance select').forEach(el => {
            el.addEventListener('change', () => {
                saveData();
                addAnalysisToTimeline('alliance');
            });
        });

        // Badge updates
        function updateBadges() {
            document.getElementById('timelineBadge').textContent = timelineItems.length;
        }

        // Update action count from facilitator
        async function updateActionCount() {
            try {
                const facilitatorData = await loadFromFirebaseLocal('facilitator_data', `move_${currentMove}`);
                const count = facilitatorData?.actions?.length || 0;
                document.getElementById('actionsBadge').textContent = count;
                
                const container = document.getElementById('facilitatorActions');
                if (facilitatorData && facilitatorData.actions && facilitatorData.actions.length > 0) {
                    container.innerHTML = facilitatorData.actions.map((d, i) => `
                        <div class="action-item">
                            <div class="action-header">
                                <span class="action-number">Action ${i + 1}</span>
                            </div>
                            <div>${d.text || d}</div>
                        </div>
                    `).join('');
                    return;
                }
            } catch (error) {
                console.error('Error loading facilitator data:', error);
                // Fallback to localStorage
                const facilitatorData = localStorage.getItem(`blueFacilitatorMove${currentMove}`);
                const count = facilitatorData ? JSON.parse(facilitatorData).actions?.length || 0 : 0;
                document.getElementById('actionsBadge').textContent = count;
                
                const container = document.getElementById('facilitatorActions');
                if (facilitatorData) {
                    const data = JSON.parse(facilitatorData);
                    if (data.actions && data.actions.length > 0) {
                        container.innerHTML = data.actions.map((d, i) => `
                            <div class="action-item">
                                <div class="action-header">
                                    <span class="action-number">Action ${i + 1}</span>
                                </div>
                                <div>${d.text || d}</div>
                            </div>
                        `).join('');
                        return;
                    }
                }
            }
            const container = document.getElementById('facilitatorActions');
            container.innerHTML = `
                <div class="empty-state" style="padding: 24px;">
                    <p>No actions submitted via Facilitator</p>
                </div>
            `;
        }

        // Data persistence
        async function saveData() {
            const data = {
                phase: currentPhase,
                timelineItems: timelineItems,
                leader: document.querySelector('.quick-btn[data-group="leader"].selected')?.getAttribute('data-value'),
                leadershipNotes: document.getElementById('leadershipNotes')?.value,
                decisionStyle: document.getElementById('decisionStyle')?.value,
                debateVsExecute: document.getElementById('debateVsExecute')?.value,
                timeInternal: document.getElementById('timeInternal')?.value,
                timeIndustry: document.getElementById('timeIndustry')?.value,
                timePrepGreen: document.getElementById('timePrepGreen')?.value,
                disagreements: document.getElementById('disagreements')?.value,
                debateIntensity: document.getElementById('debateIntensity')?.value,
                consensus: document.getElementById('consensus')?.value,
                posture: document.querySelector('.quick-btn[data-group="posture"].selected')?.getAttribute('data-value'),
                postureReason: document.getElementById('postureReason')?.value,
                keyAssumptions: document.getElementById('keyAssumptions')?.value,
                legislativePriorities: document.getElementById('legislativePriorities')?.value,
                executivePriorities: document.getElementById('executivePriorities')?.value,
                industryPriorities: document.getElementById('industryPriorities')?.value,
                priorityConflicts: document.getElementById('priorityConflicts')?.value,
                blindSpots: document.getElementById('blindSpots')?.value,
                powersave: document.querySelector('.quick-btn[data-group="powersave"].selected')?.getAttribute('data-value'),
                powerStrategy: document.getElementById('powerStrategy')?.value,
                actionsRevised: document.getElementById('actionsRevised')?.value,
                decisionSpeed: document.getElementById('decisionSpeed')?.value,
                'time-objective': document.querySelector('.quick-btn[data-group="time-objective"].selected')?.getAttribute('data-value'),
                efficiencyNotes: document.getElementById('efficiencyNotes')?.value,
                manualActions: document.getElementById('manualActions')?.value,
                allyFeedback: document.getElementById('allyFeedback')?.value,
                'ally-impact': document.querySelector('.quick-btn[data-group="ally-impact"].selected')?.getAttribute('data-value'),
                blueReactionAllies: document.getElementById('blueReactionAllies')?.value,
                allyBasedChanges: document.getElementById('allyBasedChanges')?.value,
                coalitionImpact: document.getElementById('coalitionImpact')?.value,
                redReports: document.getElementById('redReports')?.value,
                blueRedAssessment: document.getElementById('blueRedAssessment')?.value,
                'red-impact': document.querySelector('.quick-btn[data-group="red-impact"].selected')?.getAttribute('data-value'),
                redCounterActions: document.getElementById('redCounterActions')?.value,
                whiteOutcomes: document.getElementById('whiteOutcomes')?.value,
                blueReactionOutcomes: document.getElementById('blueReactionOutcomes')?.value,
                gameState: document.getElementById('gameState')?.value
            };
            
            try {
                // Save to Firebase
                await saveToFirebaseLocal('notetaker_data', `move_${currentMove}`, data);
                console.log('Notetaker data saved to Firebase');
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                // Fallback to localStorage
                localStorage.setItem(`blueMove${currentMove}`, JSON.stringify(data));
            }
        }

        async function loadData() {
            let data;
            
            // Try to load from Firebase/localStorage
            data = await loadFromFirebaseLocal('notetaker_data', `move_${currentMove}`);
            if (!data) {
                // Fallback to localStorage
                const localData = localStorage.getItem(`blueMove${currentMove}`);
                data = localData ? JSON.parse(localData) : null;
            }
            
            if (!data) return;

            timelineItems = data.timelineItems || [];
            updateTimeline();
            updateBadges();

            if (data.phase) {
                currentPhase = data.phase;
                document.querySelectorAll('.phase-btn').forEach(btn => {
                    if (parseInt(btn.getAttribute('data-phase')) === currentPhase) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                updatePhaseGuidance();
            }

            const textFields = ['leadershipNotes', 'disagreements', 'consensus', 'postureReason', 'keyAssumptions',
                'legislativePriorities', 'executivePriorities', 'industryPriorities', 'priorityConflicts', 'blindSpots',
                'powerStrategy', 'efficiencyNotes', 'manualActions', 'allyFeedback', 'blueReactionAllies', 'allyBasedChanges',
                'redReports', 'blueRedAssessment', 'redCounterActions', 'whiteOutcomes', 'blueReactionOutcomes', 'gameState'];
            
            textFields.forEach(field => {
                const el = document.getElementById(field);
                if (el && data[field]) el.value = data[field];
            });

            const numFields = ['timeInternal', 'timeIndustry', 'timePrepGreen', 'actionsRevised'];
            numFields.forEach(field => {
                const el = document.getElementById(field);
                if (el && data[field]) el.value = data[field];
            });

            const selectFields = ['decisionStyle', 'decisionSpeed'];
            selectFields.forEach(field => {
                const el = document.getElementById(field);
                if (el && data[field]) el.value = data[field];
            });

            const sliderFields = ['debateVsExecute', 'debateIntensity', 'coalitionImpact'];
            sliderFields.forEach(field => {
                const el = document.getElementById(field);
                if (el && data[field]) {
                    el.value = data[field];
                    const valueEl = document.getElementById(field + 'Value') || document.getElementById('debateValue');
                    if (valueEl) valueEl.textContent = data[field];
                }
            });

            const buttonGroups = ['leader', 'posture', 'powersave', 'time-objective', 'ally-impact', 'red-impact'];
            buttonGroups.forEach(group => {
                if (data[group]) {
                    document.querySelectorAll(`.quick-btn[data-group="${group}"]`).forEach(btn => {
                        if (btn.getAttribute('data-value') === data[group]) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                }
            });
        }

        async function exportNotes() {
            await saveData();
            
            const moves = {};
            for (let i = 1; i <= 3; i++) {
                try {
                    // Try Firebase first
                    let data = await loadFromFirebaseLocal('notetaker_data', `move_${i}`);
                    if (!data) {
                        // Fallback to localStorage
                        const localData = localStorage.getItem(`blueMove${i}`);
                        data = localData ? JSON.parse(localData) : null;
                    }
                    if (data) moves[i] = data;
                } catch (error) {
                    console.error(`Error loading move ${i}:`, error);
                    // Fallback to localStorage
                    const localData = localStorage.getItem(`blueMove${i}`);
                    if (localData) moves[i] = JSON.parse(localData);
                }
            }
            
            const exportData = {
                exported: new Date().toISOString(),
                exportedBy: 'BLUE Team Notetaker',
                gameMetadata: {
                    totalMoves: 3,
                    currentMove: currentMove,
                    currentPhase: currentPhase
                },
                allMoves: moves,
                decisionTimeline: buildDecisionTimeline(moves),
                teamDynamics: buildTeamDynamicsReport(moves),
                allianceEngagement: buildAllianceReport(moves),
                factionAnalysis: buildFactionAnalysis(moves)
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T').join('_').slice(0, -5);
            a.download = `BLUE_notetaker_move_${currentMove}_${timestamp}.json`;
            a.click();
            
            alert('Export complete. All Team Dynamics and Alliance Engagement data included.');
        }

        function buildDecisionTimeline(moves) {
            const timeline = [];
            for (let move in moves) {
                const data = moves[move];
                if (data.timelineItems) {
                    data.timelineItems.forEach(item => {
                        timeline.push({
                            move: move,
                            time: item.time,
                            phase: item.phase,
                            type: item.type,
                            content: item.content
                        });
                    });
                }
            }
            return timeline;
        }

        function buildTeamDynamicsReport(moves) {
            const report = {};
            for (let move in moves) {
                const data = moves[move];
                report[move] = {
                    leadership: {
                        primaryLeader: data.leader || 'Not recorded',
                        leadershipNotes: data.leadershipNotes || '',
                        decisionStyle: data.decisionStyle || 'Not recorded'
                    },
                    timeAllocation: {
                        internalDiscussion: data.timeInternal || 0,
                        industryInput: data.timeIndustry || 0,
                        greenPreparation: data.timePrepGreen || 0
                    },
                    dividedGovernment: {
                        mainDisagreements: data.disagreements || '',
                        debateIntensity: data.debateIntensity || 5,
                        consensusMethod: data.consensus || ''
                    },
                    strategicApproach: {
                        posture: data.posture || 'Not recorded',
                        reasoning: data.postureReason || ''
                    },
                    priorities: {
                        keyAssumptions: data.keyAssumptions || '',
                        legislative: data.legislativePriorities || '',
                        executive: data.executivePriorities || '',
                        industry: data.industryPriorities || '',
                        conflicts: data.priorityConflicts || '',
                        blindSpots: data.blindSpots || ''
                    },
                    powerManagement: {
                        savingForLater: data.powersave || 'Not discussed',
                        strategy: data.powerStrategy || ''
                    },
                    efficiency: {
                        actionsRevised: data.actionsRevised || 0,
                        decisionSpeed: data.decisionSpeed || 'Not recorded',
                        metTimeObjectives: data['time-objective'] || 'Not recorded',
                        notes: data.efficiencyNotes || ''
                    },
                    scales: {
                        debateVsExecute: data.debateVsExecute || 5
                    }
                };
            }
            return report;
        }
        
        // Submit functions for analysis sections
        function submitTeamDynamics() {
            saveData();
            addAnalysisToTimeline('dynamics');
            alert('Team Dynamics analysis submitted and added to timeline.');
        }
        
        function submitAllianceEngagement() {
            saveData();
            addAnalysisToTimeline('alliance');
            alert('Alliance Engagement analysis submitted and added to timeline.');
        }
        
        function buildAllianceReport(moves) {
            const report = {};
            for (let move in moves) {
                const data = moves[move];
                report[move] = {
                    allyResponses: {
                        feedback: data.allyFeedback || '',
                        impactOnActions: data['ally-impact'] || 'Not recorded',
                        blueReaction: data.blueReactionAllies || '',
                        changesMade: data.allyBasedChanges || '',
                        coalitionImpact: data.coalitionImpact || 5
                    },
                    redActivity: {
                        reportsHeard: data.redReports || '',
                        blueAssessment: data.blueRedAssessment || '',
                        triggeredChanges: data['red-impact'] || 'Not recorded',
                        counterActions: data.redCounterActions || ''
                    },
                    outcomes: {
                        whiteCellFeedback: data.whiteOutcomes || '',
                        blueReaction: data.blueReactionOutcomes || ''
                    },
                    gameState: {
                        updates: data.gameState || ''
                    }
                };
            }
            return report;
        }

        function buildFactionAnalysis(moves) {
            const analysis = {};
            for (let move in moves) {
                const data = moves[move];
                analysis[move] = {
                    leadership: data.leader || 'Not recorded',
                    decisionStyle: data.decisionStyle || 'Not recorded',
                    debateIntensity: data.debateIntensity || 'Not recorded',
                    debateVsExecute: data.debateVsExecute || 'Not recorded'
                };
            }
            return analysis;
        }

        async function submitNotes() {
            await saveData();
            
            let data;
            try {
                data = await loadFromFirebaseLocal('notetaker_data', `move_${currentMove}`);
                if (!data) {
                    throw new Error('No Firebase data');
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                data = JSON.parse(localStorage.getItem(`blueMove${currentMove}`));
            }
            
            const timelineCount = data.timelineItems?.length || 0;
            const hasDynamics = data.leader || data.decisionStyle || data.disagreements;
            const hasAlliance = data.allyFeedback || data.redReports || data.whiteOutcomes;
            
            let summary = `Submit Move ${currentMove} to WHITE Cell?\n\n`;
            summary += `Timeline items: ${timelineCount}\n`;
            summary += `Team Dynamics: ${hasDynamics ? 'Documented' : 'Incomplete'}\n`;
            summary += `Alliance Engagement: ${hasAlliance ? 'Documented' : 'Incomplete'}\n\n`;
            summary += `This will mark data as final and ready for WHITE Cell review.`;
            
            if (confirm(summary)) {
                data.submitted = true;
                data.submittedAt = new Date().toISOString();
                data.submittedBy = 'BLUE Team Notetaker';
                
                try {
                    await saveToFirebaseLocal('submitted_notes', `move_${currentMove}`, data);
                    console.log('Submitted notes saved to Firebase');
                } catch (error) {
                    console.error('Error saving submitted notes to Firebase:', error);
                    localStorage.setItem(`blueMove${currentMove}Submitted`, JSON.stringify(data));
                }
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `BLUE_Move${currentMove}_Submitted_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                alert(`Move ${currentMove} submitted to WHITE Cell.\n\nSubmission file downloaded for your records.`);
            }
        }

        // Initialize
        updateTimer();
        updatePhaseGuidance();
        loadData();
        updateActionCount();
        
        // Simple loader hide after page load
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('loader').classList.add('hidden');
            }, 1500);
        });
        
        window.addEventListener('blueDecisionAdded', (e) => {
            if (e.detail.move === currentMove) {
                updateActionCount();
            }
        });
        
        window.addEventListener('storage', (e) => {
            if (e.key && e.key.startsWith('blueFacilitatorMove')) {
                updateActionCount();
            }
        });
        
        setInterval(saveData, 30000);
        window.addEventListener('beforeunload', saveData);
    </script>
</body>
</html>
