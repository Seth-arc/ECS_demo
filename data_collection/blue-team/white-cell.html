<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Simulation | WHITE Cell Control</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        :root {
            /* Refined Color System - Restrained Navy */
            --color-primary: #1a4480;
            --color-primary-muted: #2d5a8a;
            --color-accent: #8b1538;
            --color-accent-light: #a91d45;
            
            /* Neutral Palette - Dominant */
            --color-bg: #fafafa;
            --color-surface: #ffffff;
            --color-surface-alt: #f5f5f5;
            --color-border: #e0e0e0;
            --color-border-light: #ebebeb;
            --color-text: #1a1a1a;
            --color-text-secondary: #505050;
            --color-text-muted: #888888;
            
            /* Team Colors */
            --color-team-blue: #1a4480;
            --color-team-green: #2e7d5a;
            --color-team-red: #c23b22;
            
            /* Subtle Accents */
            --color-success: #2e7d5a;
            --color-warning: #b8860b;
            --color-alert: #c23b22;
            
            /* Typography */
            --font-serif: 'Libre Baskerville', Georgia, 'Times New Roman', serif;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
            
            /* Spacing */
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 48px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-elegant: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-sans);
            font-size: 1rem;
            line-height: 1.6;
            background: var(--color-bg);
            color: var(--color-text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header Bar - Refined and Minimal */
        .header {
            background: var(--color-surface);
            color: var(--color-text);
            padding: var(--space-sm) var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            position: relative;
            z-index: 100;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .brand-mark {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: inherit;
        }

        .brand-mark svg {
            width: 100%;
            height: 100%;
        }

        .header-title h1 {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--color-text);
            letter-spacing: 0.01em;
            margin-bottom: 1px;
        }

        .header-title p {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            letter-spacing: 0.03em;
        }

        .header-controls {
            display: flex;
            gap: var(--space-lg);
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: var(--space-xs);
            align-items: center;
        }

        .control-label {
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        /* Move Selector */
        .move-selector {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            letter-spacing: 0.03em;
        }

        .move-selector:hover {
            border-color: var(--color-text-muted);
        }

        .move-selector:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(128, 90, 213, 0.1);
        }

        /* Phase Buttons */
        .phase-btn {
            padding: 6px 10px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            cursor: pointer;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            min-width: 32px;
            text-align: center;
        }

        .phase-btn:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .phase-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .reset-btn {
            padding: 6px 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-alert);
            color: var(--color-alert);
            cursor: pointer;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            transition: all var(--transition-fast);
        }

        .reset-btn:hover {
            background: var(--color-alert);
            color: white;
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar - Light and Clean */
        .sidebar {
            width: 260px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            overflow-y: auto;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .section-nav {
            padding: var(--space-md) var(--space-sm);
            flex: 1;
        }

        .nav-section-label {
            font-family: var(--font-mono);
            font-size: 0.5625rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--color-text-muted);
            padding: 0 var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .nav-item {
            padding: 12px var(--space-sm);
            margin-bottom: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--transition-smooth);
            border-radius: 6px;
            position: relative;
        }

        .nav-item:hover {
            background: var(--color-surface-alt);
        }

        .nav-item.active {
            background: var(--color-surface-alt);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: var(--color-primary);
            border-radius: 0 2px 2px 0;
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
        }

        .nav-icon svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        .nav-item.active .nav-icon {
            color: var(--color-primary);
        }

        .nav-content {
            flex: 1;
        }

        .nav-title {
            font-weight: 500;
            font-size: 0.8125rem;
            color: var(--color-text);
            letter-spacing: 0.01em;
        }

        .nav-item.active .nav-title {
            font-weight: 600;
        }

        .nav-subtitle {
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            margin-top: 1px;
        }

        .nav-badge {
            background: var(--color-surface-alt);
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            font-size: 0.625rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
            border: 1px solid var(--color-border);
        }

        .nav-item.active .nav-badge {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Sidebar Timer */
        .sidebar-timer {
            padding: var(--space-md);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface-alt);
            text-align: center;
        }

        .timer-label {
            font-family: var(--font-mono);
            font-size: 0.5625rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--color-text-muted);
            margin-bottom: var(--space-xs);
        }

        .timer {
            font-size: 2.25rem;
            font-weight: 600;
            font-family: var(--font-mono);
            color: var(--color-text);
            letter-spacing: 0.03em;
        }

        .timer.warning { 
            color: var(--color-warning); 
        }
        
        .timer.critical { 
            color: var(--color-alert); 
            animation: timerPulse 1s ease-in-out infinite; 
        }

        @keyframes timerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timer-controls {
            display: flex;
            gap: 6px;
            margin-top: var(--space-sm);
            justify-content: center;
        }

        .timer-btn {
            padding: 6px 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            cursor: pointer;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all var(--transition-fast);
        }

        .timer-btn:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        /* Sidebar Actions */
        .sidebar-actions {
            padding: var(--space-sm);
            border-top: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .sidebar-actions .btn {
            width: 100%;
            justify-content: center;
            font-size: 0.6875rem;
            padding: 10px 12px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg) var(--space-xl);
            background: var(--color-bg);
        }

        .section-content {
            display: none;
            max-width: 900px;
            margin: 0 auto;
            opacity: 0;
            transform: translateY(8px);
        }

        .section-content.active {
            display: block;
            animation: sectionFadeIn 0.35s var(--transition-elegant) forwards;
        }

        @keyframes sectionFadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .section-header h2 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 4px;
            letter-spacing: 0.01em;
        }

        .section-header p {
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }

        /* Phase Guidance */
        .phase-guidance {
            background: var(--color-surface);
            border-left: 3px solid var(--color-primary);
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            border-radius: 0 6px 6px 0;
        }

        .phase-guidance strong {
            display: block;
            margin-bottom: 4px;
            font-family: var(--font-mono);
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-primary);
        }

        /* Cards */
        .note-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 8px;
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            transition: all var(--transition-smooth);
        }

        .note-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .note-card h3 {
            font-family: var(--font-sans);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--color-border-light);
        }

        .card-icon {
            width: 22px;
            height: 22px;
            background: var(--color-surface-alt);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-border);
        }

        .card-icon svg {
            width: 12px;
            height: 12px;
            stroke: var(--color-text-muted);
            stroke-width: 2;
            fill: none;
        }

        /* Quick Capture Section */
        .quick-capture-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .quick-capture-title {
            font-family: var(--font-serif);
            font-size: 0.9375rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
            color: var(--color-text);
        }

        .capture-type-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: var(--space-sm);
            flex-wrap: wrap;
        }

        .capture-tab {
            padding: 8px 14px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .capture-tab:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .capture-tab.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .capture-section-label {
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .quick-textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.9375rem;
            font-family: var(--font-sans);
            min-height: 120px;
            background: var(--color-surface);
            color: var(--color-text);
            line-height: 1.6;
            transition: all var(--transition-fast);
            resize: vertical;
        }

        .quick-textarea:focus {
            outline: none;
            border-color: var(--color-text-muted);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.03);
        }

        .quick-textarea::placeholder {
            color: var(--color-text-muted);
        }

        .capture-hint {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 8px;
            font-style: italic;
        }

        /* Form Elements */
        .form-field {
            margin-bottom: var(--space-md);
        }

        .form-label {
            display: block;
            font-weight: 500;
            font-size: 0.8125rem;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.9375rem;
            font-family: var(--font-sans);
            background: var(--color-surface);
            color: var(--color-text);
            transition: all var(--transition-fast);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-text-muted);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.03);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.6;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            font-family: var(--font-sans);
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-text);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-text-secondary);
        }

        .btn-secondary {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .btn-success {
            background: var(--color-primary);
            color: white;
        }

        .btn-success:hover {
            background: var(--color-primary-muted);
        }

        /* Quick Buttons */
        .quick-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .quick-btn {
            padding: 8px 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-secondary);
        }

        .quick-btn:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text);
        }

        .quick-btn.selected {
            background: var(--color-text);
            border-color: var(--color-text);
            color: white;
        }

        .faction-tag.selected {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        /* Timeline */
        .timeline {
            max-height: 500px;
            overflow-y: auto;
        }

        .timeline-item {
            padding: var(--space-sm);
            border-left: 2px solid var(--color-border);
            background: var(--color-surface);
            margin-bottom: 12px;
            transition: all var(--transition-fast);
        }

        .timeline-item:hover {
            border-left-color: var(--color-primary);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timeline-time {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .timeline-type {
            font-family: var(--font-mono);
            font-size: 0.5625rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .timeline-type.note {
            background: var(--color-surface-alt);
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        .timeline-type.moment {
            background: var(--color-accent);
            color: white;
        }

        .timeline-type.quote {
            background: var(--color-team-blue);
            color: white;
        }

        .timeline-type.requestinfo {
            background: var(--color-primary);
            color: white;
        }

        .timeline-content {
            font-size: 0.9375rem;
            color: var(--color-text);
            line-height: 1.5;
        }

        /* Team Columns */
        .team-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .team-column {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .team-column-header {
            padding: 12px var(--space-sm);
            border-bottom: 1px solid var(--color-border);
        }

        .team-column-header.blue {
            background: var(--color-team-blue);
            color: white;
        }

        .team-column-header.green {
            background: var(--color-team-green);
            color: white;
        }

        .team-column-header.red {
            background: var(--color-team-red);
            color: white;
        }

        .team-column-label {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            opacity: 0.8;
        }

        .team-column-title {
            font-weight: 600;
            margin-top: 4px;
        }

        .team-column-count {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        .team-timeline {
            flex: 1;
            overflow-y: auto;
            max-height: 600px;
            padding: 0;
        }

        /* Action List */
        .action-item {
            background: var(--color-surface);
            padding: var(--space-sm);
            margin-bottom: var(--space-xs);
            border: 1px solid var(--color-border);
            border-radius: 6px;
        }

        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xs);
        }

        .action-number {
            font-weight: 600;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--color-primary);
        }

        /* Alert */
        .alert {
            padding: 14px var(--space-md);
            margin-bottom: var(--space-md);
            font-size: 0.8125rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            background: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: 6px;
            color: var(--color-text-secondary);
        }

        .alert-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            color: var(--color-text-muted);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--color-text-muted);
        }

        .empty-state-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto var(--space-sm);
            opacity: 0.3;
            color: var(--color-text-muted);
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        .empty-state p:last-child {
            font-size: 0.75rem;
            margin-top: 6px;
            opacity: 0.7;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }

            .content-area {
                padding: var(--space-md);
            }

            .section-header h2 {
                font-size: 1.25rem;
            }

            .team-columns {
                grid-template-columns: 1fr;
            }
        }

        /* Loader */
        #loader {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #FAFBFC 0%, #F5F7FA 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-globe {
            position: relative;
            width: 72px;
            height: 72px;
        }

        .loader-globe svg {
            width: 100%;
            height: 100%;
            animation: pulse-globe 2.4s ease-in-out infinite;
        }

        .loader-ring {
            position: absolute;
            inset: -12px;
            border: 1.5px solid transparent;
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1.4s linear infinite;
        }

        .loader-ring::before {
            content: '';
            position: absolute;
            inset: 6px;
            border: 1.5px solid transparent;
            border-top-color: var(--color-primary-muted);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }

        .loader-text {
            margin-top: 28px;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--color-primary);
            opacity: 0.7;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse-globe {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }
    </style>
</head>
<body>
    <div id="loader" aria-label="Loading simulation environment">
        <div class="loader-globe">
            <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.2"/>
                <ellipse cx="24" cy="24" rx="22" ry="10" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.3"/>
                <ellipse cx="24" cy="24" rx="10" ry="22" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.3"/>
                <path d="M2 24h44" stroke="currentColor" stroke-width="1.5" opacity="0.25"/>
                <path d="M24 2v44" stroke="currentColor" stroke-width="1.5" opacity="0.25"/>
                <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
            <div class="loader-ring"></div>
        </div>
        <div class="loader-text">Initializing</div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-brand">
            <a href="../../index.html" class="brand-mark">
                <svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                    <ellipse cx="25" cy="25" rx="23" ry="23" fill="none" stroke="#4A5568" stroke-width="1.5"/>
                    <ellipse cx="25" cy="25" rx="23" ry="10" fill="none" stroke="#4A5568" stroke-width="1" opacity="0.6"/>
                    <ellipse cx="25" cy="25" rx="10" ry="23" fill="none" stroke="#4A5568" stroke-width="1" opacity="0.6"/>
                    <ellipse cx="25" cy="25" rx="10" ry="23" fill="none" stroke="#4A5568" stroke-width="1" opacity="0.4" transform="rotate(60 25 25)"/>
                    <ellipse cx="25" cy="25" rx="10" ry="23" fill="none" stroke="#4A5568" stroke-width="1" opacity="0.4" transform="rotate(-60 25 25)"/>
                    <line x1="2" y1="25" x2="48" y2="25" stroke="#4A5568" stroke-width="1" opacity="0.4"/>
                </svg>
            </a>
            <div class="header-title">
                <h1>WHITE Cell Control</h1>
                <p id="moveEpoch">Move 1: Epoch 1 (2027-2030)</p>
            </div>
        </div>
        
        <div class="header-controls">
            <div class="control-group">
                <span class="control-label">Move:</span>
                <select id="moveSelector" onchange="changeMoveContext()" class="move-selector">
                    <option value="1">Move 1</option>
                    <option value="2">Move 2</option>
                    <option value="3">Move 3</option>
                </select>
            </div>
            <div class="control-group">
                <span class="control-label">Phase:</span>
                <div id="phaseIndicator" style="display: flex; gap: 4px;">
                    <button class="phase-btn active" data-phase="1">1</button>
                    <button class="phase-btn" data-phase="2">2</button>
                    <button class="phase-btn" data-phase="3">3</button>
                    <button class="phase-btn" data-phase="4">4</button>
                    <button class="phase-btn" data-phase="5">5</button>
                </div>
            </div>
            <button class="reset-btn" onclick="resetAllLocalStorage()">Reset Data</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="section-nav">
                <div class="nav-section-label">Sections</div>
                
                <div class="nav-item active" data-section="timeline">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Timeline</div>
                        <div class="nav-subtitle">All team updates</div>
                    </div>
                    <span class="nav-badge" id="timelineBadge">0</span>
                </div>

                <div class="nav-item" data-section="capture">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Quick Capture</div>
                        <div class="nav-subtitle">Add observations</div>
                    </div>
                </div>

                <div class="nav-item" data-section="requests">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Requests for Info</div>
                        <div class="nav-subtitle">From BLUE team</div>
                    </div>
                    <span class="nav-badge" id="requestsBadge">0</span>
                </div>

                <div class="nav-item" data-section="actions">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Actions Decided</div>
                        <div class="nav-subtitle">Team submissions</div>
                    </div>
                    <span class="nav-badge" id="actionsBadge">0</span>
                </div>

                <div class="nav-item" data-section="adjudication">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Adjudication</div>
                        <div class="nav-subtitle">Rulings & outcomes</div>
                    </div>
                    <span class="nav-badge" id="adjudicationBadge">0</span>
                </div>

                <div class="nav-item" data-section="communication">
                    <div class="nav-icon">
                        <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    </div>
                    <div class="nav-content">
                        <div class="nav-title">Communication</div>
                        <div class="nav-subtitle">Send responses</div>
                    </div>
                    <span class="nav-badge" id="communicationBadge">0</span>
                </div>
            </div>
            
            <div class="sidebar-actions">
                <button class="btn btn-secondary" onclick="exportNotes()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export Data
                </button>
                <button class="btn btn-success" onclick="submitNotes()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    Finalize Move
                </button>
            </div>
            
            <div class="sidebar-timer">
                <div class="timer-label">Time Remaining</div>
                <div class="timer" id="timer">90:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" id="startTimer">Start</button>
                    <button class="timer-btn" id="pauseTimer">Pause</button>
                    <button class="timer-btn" id="resetTimer">Reset</button>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Timeline Section -->
            <div class="section-content active" id="timeline">
                <div class="section-header">
                    <div>
                        <h2>Timeline</h2>
                        <p>Real-time team observations</p>
                    </div>
                    <button class="btn btn-secondary" onclick="updateTimeline()" style="font-size: 0.75rem; padding: 6px 12px;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        Refresh
                    </button>
                </div>

                <div class="alert">
                    <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <span><strong>Team Updates:</strong> Real-time timeline entries from all teams appear in their respective columns below automatically.</span>
                </div>

                <div class="team-columns">
                    <!-- BLUE Team Column -->
                    <div class="team-column">
                        <div class="team-column-header blue">
                            <div class="team-column-label">BLUE Team</div>
                            <div class="team-column-title">Timeline</div>
                            <div class="team-column-count" id="blueTimelineCount">0 items</div>
                        </div>
                        <div class="team-timeline" id="blueTimeline">
                            <div class="empty-state">
                                <p>No BLUE team items yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- GREEN Team Column -->
                    <div class="team-column">
                        <div class="team-column-header green">
                            <div class="team-column-label">GREEN Allies</div>
                            <div class="team-column-title">Timeline</div>
                            <div class="team-column-count" id="greenTimelineCount">0 items</div>
                        </div>
                        <div class="team-timeline" id="greenTimeline">
                            <div class="empty-state">
                                <p>No GREEN team items yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- RED Team Column -->
                    <div class="team-column">
                        <div class="team-column-header red">
                            <div class="team-column-label">RED Adversaries</div>
                            <div class="team-column-title">Timeline</div>
                            <div class="team-column-count" id="redTimelineCount">0 items</div>
                        </div>
                        <div class="team-timeline" id="redTimeline">
                            <div class="empty-state">
                                <p>No RED team items yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Capture Section -->
            <div class="section-content" id="capture">
                <div class="section-header">
                    <div>
                        <h2>Quick Capture</h2>
                        <p>Capture observations across all teams</p>
                    </div>
                </div>

                <div id="phaseGuidanceContainer"></div>

                <div class="quick-capture-section">
                    <div class="quick-capture-title">What are you capturing?</div>
                    
                    <div class="capture-type-tabs">
                        <div class="capture-tab active" data-type="note">General Note</div>
                        <div class="capture-tab" data-type="moment">Key Moment</div>
                        <div class="capture-tab" data-type="quote">Important Quote</div>
                        <div class="capture-tab" data-type="requestinfo">Ruling/Clarification</div>
                    </div>

                    <div style="margin-bottom: var(--space-sm);">
                        <div class="capture-section-label">Which team? (optional)</div>
                        <div class="quick-buttons" id="factionButtons">
                            <button class="quick-btn faction-tag" data-faction="blue">BLUE Team</button>
                            <button class="quick-btn faction-tag" data-faction="green">GREEN Allies</button>
                            <button class="quick-btn faction-tag" data-faction="red">RED Adversaries</button>
                            <button class="quick-btn faction-tag" data-faction="cross">Cross-Team</button>
                        </div>
                    </div>

                    <div style="margin-bottom: var(--space-sm);">
                        <div class="capture-section-label">Simulation phase markers (optional)</div>
                        <div class="quick-buttons">
                            <button class="quick-btn debate-marker" data-marker="started">Phase Started</button>
                            <button class="quick-btn debate-marker" data-marker="shifted">Team Interaction</button>
                            <button class="quick-btn debate-marker" data-marker="actions">Adjudication Needed</button>
                            <button class="quick-btn debate-marker" data-marker="consensus">Ruling Made</button>
                        </div>
                    </div>

                    <div style="margin-bottom: var(--space-sm);">
                        <div class="capture-section-label">Quick templates</div>
                        <div class="quick-buttons">
                            <button class="quick-btn template-btn" onclick="insertTemplate('disagree')">Team Conflict</button>
                            <button class="quick-btn template-btn" onclick="insertTemplate('consensus')">Cross-Team Coordination</button>
                            <button class="quick-btn template-btn" onclick="insertTemplate('question')">Clarification Requested</button>
                            <button class="quick-btn template-btn" onclick="insertTemplate('concern')">Game Balance Issue</button>
                        </div>
                    </div>

                    <textarea class="quick-textarea" id="quickCaptureText" placeholder="Type what you're observing across teams..."></textarea>
                    
                    <div class="capture-hint" id="captureHint">
                        Cross-team dynamics, rule clarifications, fairness observations, game state...
                    </div>

                    <button class="btn btn-success" onclick="addCapture()" style="margin-top: var(--space-sm);">Add to Timeline</button>
                </div>

                <div class="alert">
                    <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <span><strong>Tip:</strong> Keep typing in Quick Capture. Document key adjudications and cross-team interactions during the game.</span>
                </div>
            </div>

            <!-- Requests for Info Section -->
            <div class="section-content" id="requests">
                <div class="section-header">
                    <div>
                        <h2>Requests for Info</h2>
                        <p>Questions from BLUE team</p>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        </span>
                        Questions
                    </h3>
                    <div id="requestsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            <p>No requests for information yet</p>
                            <p>Requests will appear here when submitted</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Decided Section -->
            <div class="section-content" id="actions">
                <div class="section-header">
                    <div>
                        <h2>Actions Decided</h2>
                        <p>Team submissions</p>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        </span>
                        Submitted Actions
                    </h3>
                    <div id="actionsContainer" style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                            <p>No actions submitted yet</p>
                            <p>Actions will appear here when teams submit</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Adjudication Section -->
            <div class="section-content" id="adjudication">
                <div class="section-header">
                    <div>
                        <h2>Adjudication</h2>
                        <p>Rulings and outcome determinations</p>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                        </span>
                        Add Ruling
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Subject</label>
                        <textarea class="form-textarea" id="rulingSubject" placeholder="What are you ruling on?"></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Ruling</label>
                        <textarea class="form-textarea" id="rulingText" placeholder="What is your adjudication?"></textarea>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Rationale</label>
                        <textarea class="form-textarea" id="rulingRationale" placeholder="Why are you making this ruling?"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addRuling()">Record Ruling</button>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        </span>
                        Adjudication Log
                    </h3>
                    <div id="rulingLogContainer" style="display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto;">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                            <p>No rulings recorded yet</p>
                            <p>Rulings will appear here as they are made</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communication Section -->
            <div class="section-content" id="communication">
                <div class="section-header">
                    <div>
                        <h2>Communication</h2>
                        <p>Send responses to teams and game updates</p>
                    </div>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                        </span>
                        Send Response to BLUE Team
                    </h3>
                    <div class="form-field">
                        <label class="form-label">Response Type</label>
                        <select class="form-select" id="responseType">
                            <option value="request_response">Information Request Response</option>
                            <option value="game_update">Game Update</option>
                            <option value="clarification">Clarification Needed</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="responseTitle" placeholder="Brief title for the response">
                    </div>
                    <div class="form-field">
                        <label class="form-label">Content</label>
                        <textarea class="form-textarea" id="responseContent" placeholder="Response content or game update details"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="sendResponseToBlue()">Send to BLUE Team</button>
                </div>

                <div class="note-card">
                    <h3>
                        <span class="card-icon">
                            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </span>
                        Communication Log
                    </h3>
                    <div id="communicationLogContainer" style="display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto;">
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <p>No communications sent yet</p>
                            <p>Messages will appear here when sent</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase configuration and utilities
        import { initializeFirebase, saveToFirebase, loadFromFirebase, addToFirebaseCollection, queryFirebaseCollection } from "../../firebase-config.js";

        // Initialize Firebase
        let db, auth;
        initializeFirebase().then(result => {
            if (result) {
                db = result.db;
                auth = result.auth;
                window.db = db;
                window.auth = auth;
                console.log('Firebase initialized in white-cell');
                
                // Setup real-time listeners once authenticated
                setupRealtimeListeners();
            } else {
                db = null;
                auth = null;
                window.db = null;
                window.auth = null;
            }
            // Load data after Firebase check
            loadData().then(() => {
                updateBadges();
                setInterval(saveData, 30000);
                window.addEventListener('beforeunload', saveData);
                
                // Hide loader after data is loaded
                document.getElementById('loader').classList.add('hidden');
            });
        }).catch(error => {
            console.error('Firebase initialization failed:', error);
            db = null;
            auth = null;
            window.db = null;
            window.auth = null;
            // Load data after Firebase check
            loadData().then(() => {
                updateBadges();
                setInterval(saveData, 30000);
                window.addEventListener('beforeunload', saveData);
                
                // Hide loader after data is loaded
                document.getElementById('loader').classList.add('hidden');
            });
        });
        
        // Firebase utility functions (now using imported functions)
        async function saveToFirebaseLocal(collectionName, docId, data) {
            if (db) {
                return await saveToFirebase(db, collectionName, docId, data);
            } else {
                localStorage.setItem(`${collectionName}_${docId}`, JSON.stringify(data));
                return true;
            }
        }
        
        async function loadFromFirebaseLocal(collectionName, docId) {
            if (db) {
                return await loadFromFirebase(db, collectionName, docId);
            } else {
                const localData = localStorage.getItem(`${collectionName}_${docId}`);
                return localData ? JSON.parse(localData) : null;
            }
        }
        
        async function addToFirebaseCollectionLocal(collectionName, data) {
            if (db) {
                return await addToFirebaseCollection(db, collectionName, data);
            } else {
                console.log('Firebase not available, skipping add to collection');
                return null;
            }
        }
        
        async function queryFirebaseCollectionLocal(collectionName, conditions = []) {
            if (db) {
                return await queryFirebaseCollection(db, collectionName, conditions);
            } else {
                console.log('Firebase not available, skipping query');
                return [];
            }
        }
    </script>

        function changeMoveContext() {
            currentMove = parseInt(document.getElementById('moveSelector').value);
            document.getElementById('moveEpoch').textContent = moveEpochs[currentMove];
            const currentData = localStorage.getItem(`whiteCellMove${currentMove}`);
            if (currentData) {
                loadData();
            } else {
                document.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.id && el.id !== 'moveSelector') el.value = '';
                });
                timelineItems = [];
                updateTimeline();
                updateBadges();
            }
        }

        // Phase Management
        let currentPhase = 1;
        let currentFaction = null;

        const phaseGuidance = {
            1: "Phase 1: Internal Deliberation (30-40 min) - Monitor all teams' internal discussions and strategic decisions",
            2: "Phase 2: Alliance Consultation (20-30 min) - Track cross-team interactions and alliance negotiations",
            3: "Phase 3: Finalization (10-15 min) - Capture final action decisions from all teams",
            4: "Phase 4: Adjudication (15-20 min) - Process submissions and determine outcomes",
            5: "Phase 5: Results Brief (10-15 min) - Deliver outcomes and capture team reactions"
        };

        function updatePhaseGuidance() {
            const container = document.getElementById('phaseGuidanceContainer');
            container.innerHTML = `
                <div class="phase-guidance">
                    <strong>Current Phase ${currentPhase}</strong>
                    ${phaseGuidance[currentPhase]}
                </div>
            `;
        }

        document.querySelectorAll('.phase-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.phase-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPhase = parseInt(btn.getAttribute('data-phase'));
                updatePhaseGuidance();
                saveData();
            });
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                const sectionId = item.getAttribute('data-section');
                document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
                
                if (sectionId === 'requests') loadSubmittedRequests();
                if (sectionId === 'actions') loadSubmittedActions();
                if (sectionId === 'timeline') updateTimeline();
                if (sectionId === 'communication') displayCommunicationLog();
            });
        });

        // Faction tagging
        document.querySelectorAll('.faction-tag').forEach(btn => {
            btn.addEventListener('click', () => {
                if (currentFaction === btn.getAttribute('data-faction')) {
                    btn.classList.remove('selected');
                    currentFaction = null;
                } else {
                    document.querySelectorAll('.faction-tag').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    currentFaction = btn.getAttribute('data-faction');
                }
            });
        });

        // Simulation phase markers
        document.querySelectorAll('.debate-marker').forEach(btn => {
            btn.addEventListener('click', () => {
                const marker = btn.getAttribute('data-marker');
                const markers = {
                    'started': '[PHASE STARTED]',
                    'shifted': '[TEAM INTERACTION]',
                    'actions': '[ADJUDICATION NEEDED]',
                    'consensus': '[RULING MADE]'
                };
                const textarea = document.getElementById('quickCaptureText');
                textarea.value = markers[marker] + ' ' + textarea.value;
            });
        });

        // Quick templates
        function insertTemplate(type) {
            const templates = {
                'disagree': `TEAM CONFLICT
 Team A: ___
 Team B: ___
 Conflict Type: ___
 Adjudication Needed: ___`,
                
                'consensus': `CROSS-TEAM COORDINATION
 Teams Involved: ___
 Coordination Type: ___
 Effectiveness: ___
 Impact: ___`,
                
                'question': `CLARIFICATION REQUESTED
 Team: ___
 Question: "___"
 Ruling Provided: ___
 Impact: ___`,
                
                'concern': `GAME BALANCE ISSUE
 Issue: ___
 Team(s) Affected: ___
 Assessment: ___
 Action Taken: ___`,
                
                'requestinfo': `RULING/OUTCOME
 Team(s): ___
 Action Being Adjudicated: ___
 Ruling: ___
 Rationale: ___
 Impact on decision: ___`
            };
            const textarea = document.getElementById('quickCaptureText');
            textarea.value = templates[type];
            textarea.focus();
            setTimeout(() => {
                const firstBlank = textarea.value.indexOf('___');
                if (firstBlank !== -1) {
                    textarea.setSelectionRange(firstBlank, firstBlank + 3);
                }
            }, 10);
        }

        // Timer
        let timerSeconds = 90 * 60;
        let timerInterval = null;
        let isRunning = false;

        function updateTimer() {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            const display = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const timer = document.getElementById('timer');
            timer.textContent = display;
            
            timer.classList.remove('warning', 'critical');
            if (timerSeconds <= 300 && timerSeconds > 60) timer.classList.add('warning');
            else if (timerSeconds <= 60) timer.classList.add('critical');
        }

        document.getElementById('startTimer').onclick = () => {
            if (!isRunning) {
                isRunning = true;
                timerInterval = setInterval(() => {
                    if (timerSeconds > 0) {
                        timerSeconds--;
                        updateTimer();
                    } else {
                        clearInterval(timerInterval);
                        alert('Time is up!');
                    }
                }, 1000);
            }
        };

        document.getElementById('pauseTimer').onclick = () => {
            isRunning = false;
            clearInterval(timerInterval);
        };

        document.getElementById('resetTimer').onclick = () => {
            isRunning = false;
            clearInterval(timerInterval);
            timerSeconds = 90 * 60;
            updateTimer();
        };

        // Capture Type Tabs
        let currentCaptureType = 'note';
        const hints = {
            note: 'Cross-team dynamics, rule clarifications, fairness observations, game state...',
            moment: 'Critical adjudication moments, major team decisions, turning points...',
            quote: 'Important statements from teams - include context and impact',
            requestinfo: 'Rulings made, clarifications provided, outcome determinations...'
        };

        document.querySelectorAll('.capture-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.capture-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentCaptureType = tab.getAttribute('data-type');
                document.getElementById('captureHint').textContent = hints[currentCaptureType];
                
                const placeholders = {
                    note: 'Type what you\'re observing right now...',
                    moment: 'Describe this critical moment...',
                    quote: '"Quote text here" - Speaker Name (context about why this matters)',
                    requestinfo: 'Question: ___ | Asked by: ___ | Response: ___'
                };
                document.getElementById('quickCaptureText').placeholder = placeholders[currentCaptureType];
            };
        });

        // Timeline
        let timelineItems = [];

        async function addCapture() {
            const text = document.getElementById('quickCaptureText').value.trim();
            if (text) {
                let content = text;
                if (currentFaction) {
                    const factionLabels = {
                        'blue': 'BLUE',
                        'green': 'GREEN',
                        'red': 'RED',
                        'cross': 'Cross-Team'
                    };
                    content = `[${factionLabels[currentFaction]}] ${text}`;
                }
                const item = {
                    type: currentCaptureType,
                    time: new Date().toLocaleTimeString(),
                    content: content,
                    timestamp: Date.now(),
                    phase: currentPhase,
                    faction: currentFaction,
                    team: 'WHITE',
                    move: currentMove
                };
                timelineItems.push(item);
                
                // Save to Firebase for cross-team sharing
                try {
                    await addToFirebaseCollectionLocal('timeline', item);
                    console.log('Timeline item saved to Firebase');
                } catch (error) {
                    console.error('Error saving timeline item to Firebase:', error);
                }
                
                document.getElementById('quickCaptureText').value = '';
                updateTimeline();
                updateBadges();
                saveData();
            }
        }

        // Allow Enter to submit (Shift+Enter for new line)
        document.getElementById('quickCaptureText').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addCapture();
            }
        });

        async function updateTimeline() {
            const allTimelineItems = [...timelineItems];
            
            try {
                // Load timeline items from Firebase
                const firebaseItems = await queryFirebaseCollectionLocal('timeline', [
                    { field: 'move', operator: '==', value: currentMove }
                ]);
                
                firebaseItems.forEach((data) => {
                    allTimelineItems.push({
                        type: data.type,
                        time: new Date(data.timestamp).toLocaleTimeString(),
                        content: data.content,
                        timestamp: new Date(data.timestamp).getTime(),
                        team: data.team
                    });
                });
            } catch (error) {
                console.error('Error loading timeline from Firebase:', error);
                // Continue with local data only
            }
            
            // Separate items by team
            const blueItems = allTimelineItems.filter(item => item.team === 'BLUE');
            const greenItems = allTimelineItems.filter(item => item.team === 'GREEN');
            const redItems = allTimelineItems.filter(item => item.team === 'RED');
            
            // Update counts
            document.getElementById('blueTimelineCount').textContent = `${blueItems.length} item${blueItems.length !== 1 ? 's' : ''}`;
            document.getElementById('greenTimelineCount').textContent = `${greenItems.length} item${greenItems.length !== 1 ? 's' : ''}`;
            document.getElementById('redTimelineCount').textContent = `${redItems.length} item${redItems.length !== 1 ? 's' : ''}`;
            
            // Render each team's timeline
            renderTeamTimeline('blueTimeline', blueItems, 'BLUE');
            renderTeamTimeline('greenTimeline', greenItems, 'GREEN');
            renderTeamTimeline('redTimeline', redItems, 'RED');
        }

        function renderTeamTimeline(containerId, items, team) {
            const container = document.getElementById(containerId);
            const teamColor = getTeamColor(team);
            
            // Clear existing content
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>No ${team} team items yet</p></div>`;
            } else {
                // Sort items in reverse chronological order
                const sortedItems = items.slice().reverse();
                
                sortedItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'timeline-item';
                    itemDiv.style.margin = '0';
                    itemDiv.style.borderRadius = '0';
                    itemDiv.style.borderBottom = '1px solid var(--color-border)';
                    itemDiv.style.borderLeft = `3px solid ${teamColor}`;
                    
                    const typeLabel = item.type === 'note' ? 'Note' :
                                    item.type === 'moment' ? 'Moment' :
                                    item.type === 'quote' ? 'Quote' : 'Info';
                    
                    itemDiv.innerHTML = `
                        <div class="timeline-header">
                            <span class="timeline-time">${item.time}</span>
                            <span class="timeline-type ${item.type}">${typeLabel}</span>
                        </div>
                        <div class="timeline-content">${item.content}</div>
                    `;
                    
                    container.appendChild(itemDiv);
                });
            }
        }

        function getTeamColor(team) {
            const colors = {
                'BLUE': 'var(--color-team-blue)',
                'GREEN': 'var(--color-team-green)',
                'RED': 'var(--color-team-red)'
            };
            return colors[team] || 'var(--color-border)';
        }

        function updateBadges() {
            let totalTimelineItems = timelineItems.filter(i => i.team !== 'WHITE').length;
            
            const blueSubmitted = localStorage.getItem(`blueMove${currentMove}Submitted`);
            if (blueSubmitted) {
                const blueData = JSON.parse(blueSubmitted);
                totalTimelineItems += blueData.timelineItems?.length || 0;
            }
            
            const greenSubmitted = localStorage.getItem(`greenMove${currentMove}Submitted`);
            if (greenSubmitted) {
                const greenData = JSON.parse(greenSubmitted);
                totalTimelineItems += greenData.timelineItems?.length || 0;
            }
            
            const redSubmitted = localStorage.getItem(`redMove${currentMove}Submitted`);
            if (redSubmitted) {
                const redData = JSON.parse(redSubmitted);
                totalTimelineItems += redData.timelineItems?.length || 0;
            }
            
            document.getElementById('timelineBadge').textContent = totalTimelineItems;
            
            const requestsData = localStorage.getItem(`blueRequestsSubmittedMove${currentMove}`);
            const requestCount = requestsData ? JSON.parse(requestsData).requests?.length || 0 : 0;
            document.getElementById('requestsBadge').textContent = requestCount;
            
            const actionsData = localStorage.getItem(`blueActionsSubmittedMove${currentMove}`);
            const actionCount = actionsData ? JSON.parse(actionsData).actions?.length || 0 : 0;
            document.getElementById('actionsBadge').textContent = actionCount;
            
            const rulings = JSON.parse(localStorage.getItem('whiteCellRulings') || '[]');
            document.getElementById('adjudicationBadge').textContent = rulings.length;
            
            const responses = JSON.parse(localStorage.getItem('whiteCellResponses') || '[]');
            const commCount = responses.filter(r => r.move === currentMove).length;
            document.getElementById('communicationBadge').textContent = commCount;
        }

        function loadSubmittedRequests() {
            const container = document.getElementById('requestsContainer');
            const requestsData = localStorage.getItem(`blueRequestsSubmittedMove${currentMove}`);
            
            if (!requestsData) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <p>No requests for information yet</p>
                        <p>Requests will appear here when submitted</p>
                    </div>
                `;
                return;
            }
            
            const submission = JSON.parse(requestsData);
            const requests = submission.requests || [];
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <p>No requests for information yet</p>
                        <p>Requests will appear here when submitted</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = requests.map(request => `
                <div class="action-item">
                    <div class="action-header">
                        <span class="action-number">${request.title}</span>
                        <span style="font-size: 0.6875rem; color: var(--color-text-muted);">${request.category} - ${request.priority.toUpperCase()}</span>
                    </div>
                    <div style="font-size: 0.875rem; line-height: 1.5; margin-bottom: 8px;">${request.details}</div>
                    <div style="font-size: 0.75rem; color: var(--color-text-muted);">
                        Submitted: ${new Date(request.timestamp).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        function loadSubmittedActions() {
            const container = document.getElementById('actionsContainer');
            const actionsData = localStorage.getItem(`blueActionsSubmittedMove${currentMove}`);
            
            if (!actionsData) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        <p>No actions submitted yet</p>
                        <p>Actions will appear here when teams submit</p>
                    </div>
                `;
                return;
            }
            
            const submission = JSON.parse(actionsData);
            const actions = submission.actions || [];
            
            if (actions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                        </svg>
                        <p>No actions submitted yet</p>
                        <p>Actions will appear here when teams submit</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = actions.map(action => `
                <div class="action-item">
                    <div class="action-header">
                        <span class="action-number">${action.title}</span>
                        <span style="font-size: 0.6875rem; color: var(--color-text-muted);">${action.toolType} - Target: ${action.target}</span>
                    </div>
                    <div style="font-size: 0.875rem; line-height: 1.5; margin-bottom: 8px;">${action.goal}</div>
                    <div style="font-size: 0.75rem; color: var(--color-text-muted);">
                        Submitted: ${new Date(action.timestamp || submission.submittedAt).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }

        // Rulings with Firebase
        async function addRuling() {
            const subject = document.getElementById('rulingSubject').value.trim();
            const ruling = document.getElementById('rulingText').value.trim();
            const rationale = document.getElementById('rulingRationale').value.trim();
            
            if (!subject || !ruling) {
                alert('Please fill in subject and ruling');
                return;
            }
            
            const rulingRecord = {
                subject: subject,
                ruling: ruling,
                rationale: rationale,
                time: new Date().toLocaleTimeString(),
                timestamp: Date.now(),
                move: currentMove
            };
            
            try {
                // Save to Firebase
                await addToFirebaseCollectionLocal('rulings', rulingRecord);
                console.log('Ruling saved to Firebase');
            } catch (error) {
                console.error('Error saving ruling to Firebase:', error);
                // Fallback to localStorage
                let rulings = JSON.parse(localStorage.getItem('whiteCellRulings') || '[]');
                rulings.push(rulingRecord);
                localStorage.setItem('whiteCellRulings', JSON.stringify(rulings));
            }
            
            displayRulingLog();
            updateBadges();
            
            document.getElementById('rulingSubject').value = '';
            document.getElementById('rulingText').value = '';
            document.getElementById('rulingRationale').value = '';
        }

        async function displayRulingLog() {
            const container = document.getElementById('rulingLogContainer');
            
            try {
                // Load from Firebase
                const firebaseRulings = await queryFirebaseCollectionLocal('rulings', [
                    { field: 'move', operator: '==', value: currentMove }
                ]);
                const rulings = [...firebaseRulings];
                
                if (rulings.length === 0) {
                    // Check localStorage as fallback
                    const localRulings = JSON.parse(localStorage.getItem('whiteCellRulings') || '[]');
                    rulings.push(...localRulings.filter(r => r.move === currentMove || !r.move));
                }
                
                if (rulings.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                            <p>No rulings recorded yet</p>
                            <p>Rulings will appear here as they are made</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = rulings.map(r => `
                        <div class="action-item">
                            <div class="action-header">
                                <span class="action-number">${r.subject}</span>
                                <span style="font-size: 0.6875rem; color: var(--color-text-muted);">${r.time}</span>
                            </div>
                            <div style="font-size: 0.875rem; line-height: 1.5; margin-bottom: 8px;">${r.ruling}</div>
                            ${r.rationale ? `<div style="font-size: 0.75rem; color: var(--color-text-muted); font-style: italic;">Rationale: ${r.rationale}</div>` : ''}
                        </div>
                    `).reverse().join('');
                }
            } catch (error) {
                console.error('Error loading rulings from Firebase:', error);
                // Fallback to localStorage
                const rulings = JSON.parse(localStorage.getItem('whiteCellRulings') || '[]');
                
                if (rulings.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                            <p>No rulings recorded yet</p>
                            <p>Rulings will appear here as they are made</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = rulings.map(r => `
                        <div class="action-item">
                            <div class="action-header">
                                <span class="action-number">${r.subject}</span>
                                <span style="font-size: 0.6875rem; color: var(--color-text-muted);">${r.time}</span>
                            </div>
                            <div style="font-size: 0.875rem; line-height: 1.5; margin-bottom: 8px;">${r.ruling}</div>
                            ${r.rationale ? `<div style="font-size: 0.75rem; color: var(--color-text-muted); font-style: italic;">Rationale: ${r.rationale}</div>` : ''}
                        </div>
                    `).reverse().join('');
                }
            }
        }

        // Communication with Firebase
        async function sendResponseToBlue() {
            const type = document.getElementById('responseType').value;
            const title = document.getElementById('responseTitle').value.trim();
            const content = document.getElementById('responseContent').value.trim();
            
            if (!title || !content) {
                alert('Please fill in both title and content.');
                return;
            }
            
            const response = {
                type: type,
                title: title,
                content: content,
                move: currentMove,
                timestamp: new Date().toISOString(),
                respondedAt: new Date().toISOString(),
                from: 'WHITE Cell',
                to: 'BLUE Team'
            };
            
            try {
                // Save to Firebase
                await addToFirebaseCollectionLocal('communications', response);
                console.log('Communication saved to Firebase');
            } catch (error) {
                console.error('Error saving communication to Firebase:', error);
                // Fallback to localStorage
                localStorage.setItem(`whiteResponseToBlueMove${currentMove}`, JSON.stringify(response));
                
                let responses = JSON.parse(localStorage.getItem('whiteCellResponses') || '[]');
                responses.push(response);
                localStorage.setItem('whiteCellResponses', JSON.stringify(responses));
            }
            
            document.getElementById('responseTitle').value = '';
            document.getElementById('responseContent').value = '';
            
            displayCommunicationLog();
            updateBadges();
            
            alert('Response sent to BLUE Team!');
        }

        async function displayCommunicationLog() {
            const container = document.getElementById('communicationLogContainer');
            
            try {
                // Load from Firebase
                const firebaseResponses = await queryFirebaseCollectionLocal('communications', [
                    { field: 'move', operator: '==', value: currentMove }
                ]);
                const responses = [...firebaseResponses];
                
                if (responses.length === 0) {
                    // Check localStorage as fallback
                    const localResponses = JSON.parse(localStorage.getItem('whiteCellResponses') || '[]');
                    responses.push(...localResponses.filter(r => r.move === currentMove));
                }
                
                if (responses.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <p>No communications sent yet</p>
                            <p>Messages will appear here when sent</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = responses.map(response => `
                    <div class="action-item">
                        <div class="action-header">
                            <span class="action-number">${response.title}</span>
                            <span style="font-size: 0.6875rem; color: var(--color-text-muted);">${response.type.replace('_', ' ').toUpperCase()}</span>
                        </div>
                        <div style="font-size: 0.875rem; line-height: 1.5; margin-bottom: 8px;">${response.content}</div>
                        <div style="font-size: 0.75rem; color: var(--color-text-muted);">
                            Sent to BLUE Team - Move ${response.move} - ${new Date(response.timestamp).toLocaleString()}
                        </div>
                    </div>
                `).reverse().join('');
            } catch (error) {
                console.error('Error loading communications from Firebase:', error);
                // Fallback to localStorage
                const responses = JSON.parse(localStorage.getItem('whiteCellResponses') || '[]');
                
                if (responses.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            <p>No communications sent yet</p>
                            <p>Messages will appear here when sent</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = responses.map(response => `
                    <div class="action-item">
                        <div class="action-header">
                            <span class="action-number">${response.title}</span>
                            <span style="font-size: 0.6875rem; color: var(--color-text-muted);">${response.type.replace('_', ' ').toUpperCase()}</span>
                        </div>
                        <div style="font-size: 0.875rem; line-height: 1.5; margin-bottom: 8px;">${response.content}</div>
                        <div style="font-size: 0.75rem; color: var(--color-text-muted);">
                            Sent to BLUE Team - Move ${response.move} - ${new Date(response.timestamp).toLocaleString()}
                        </div>
                    </div>
                `).reverse().join('');
            }
        }

        // Save/Load with Firebase
        async function saveData() {
            const data = {
                timestamp: new Date().toISOString(),
                timerRemaining: timerSeconds,
                timelineItems: timelineItems,
                currentPhase: currentPhase,
                move: currentMove
            };
            
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id && el.id !== 'moveSelector') data[el.id] = el.value;
            });
            
            // Save to Firebase
            await saveToFirebaseLocal('whiteCellData', `move${currentMove}`, data);
            
            // Also save locally as backup
            localStorage.setItem(`whiteCellMove${currentMove}`, JSON.stringify(data));
        }

        async function loadData() {
            // Try to load from Firebase first
            const firebaseData = await loadFromFirebaseLocal('whiteCellData', `move${currentMove}`);
            
            if (firebaseData) {
                // Load from Firebase data
                Object.keys(firebaseData).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && key !== 'moveSelector') el.value = firebaseData[key];
                });
                
                if (firebaseData.timelineItems) {
                    timelineItems = firebaseData.timelineItems;
                    updateTimeline();
                    updateBadges();
                }
                
                if (firebaseData.timerRemaining) {
                    timerSeconds = firebaseData.timerRemaining;
                    updateTimer();
                }

                if (firebaseData.currentPhase) {
                    currentPhase = firebaseData.currentPhase;
                    document.querySelectorAll('.phase-btn').forEach(btn => {
                        if (parseInt(btn.getAttribute('data-phase')) === currentPhase) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    updatePhaseGuidance();
                }
            } else {
                // Fallback to localStorage
                const saved = localStorage.getItem(`whiteCellMove${currentMove}`);
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    Object.keys(data).forEach(key => {
                        const el = document.getElementById(key);
                        if (el && key !== 'moveSelector') el.value = data[key];
                    });
                    
                    if (data.timelineItems) {
                        timelineItems = data.timelineItems;
                        updateTimeline();
                        updateBadges();
                    }
                    
                    if (data.timerRemaining) {
                        timerSeconds = data.timerRemaining;
                        updateTimer();
                    }

                    if (data.currentPhase) {
                        currentPhase = data.currentPhase;
                        document.querySelectorAll('.phase-btn').forEach(btn => {
                            const isActive = parseInt(btn.getAttribute('data-phase')) === currentPhase;
                            btn.classList.toggle('active', isActive);
                        });
                        updatePhaseGuidance();
                    }
                }
            }
            
            displayRulingLog();
            displayCommunicationLog();
        }

        function exportNotes() {
            const moves = {};
            for (let i = 1; i <= 3; i++) {
                const data = localStorage.getItem(`whiteCellMove${i}`);
                if (data) moves[i] = JSON.parse(data);
            }
            
            const exportData = {
                exported: new Date().toISOString(),
                exportedBy: 'WHITE Cell Control',
                allMoves: moves,
                rulings: JSON.parse(localStorage.getItem('whiteCellRulings') || '[]'),
                communications: JSON.parse(localStorage.getItem('whiteCellResponses') || '[]'),
                decisionTimeline: buildDecisionTimeline(moves)
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T').join('_').slice(0, -5);
            a.download = `WHITE_Cell_move_${currentMove}_${timestamp}.json`;
            a.click();
        }

        function buildDecisionTimeline(moves) {
            const timeline = [];
            for (let move in moves) {
                const data = moves[move];
                if (data.timelineItems) {
                    data.timelineItems.forEach(item => {
                        timeline.push({
                            move: move,
                            time: item.time,
                            phase: item.phase,
                            type: item.type,
                            content: item.content
                        });
                    });
                }
            }
            return timeline;
        }

        function submitNotes() {
            saveData();
            const data = JSON.parse(localStorage.getItem(`whiteCellMove${currentMove}`));
            
            const timelineCount = data.timelineItems?.length || 0;
            const rulings = JSON.parse(localStorage.getItem('whiteCellRulings') || '[]');
            const communications = JSON.parse(localStorage.getItem('whiteCellResponses') || '[]');
            
            let summary = `Finalize Move ${currentMove}?\n\n`;
            summary += `Timeline items: ${timelineCount}\n`;
            summary += `Rulings recorded: ${rulings.length}\n`;
            summary += `Communications sent: ${communications.filter(c => c.move === currentMove).length}\n\n`;
            summary += `This will mark the move as complete.`;
            
            if (confirm(summary)) {
                data.finalized = true;
                data.finalizedAt = new Date().toISOString();
                localStorage.setItem(`whiteCellMove${currentMove}Finalized`, JSON.stringify(data));
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `WHITE_Cell_Move${currentMove}_Finalized_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                alert(`Move ${currentMove} finalized.\n\nFinalization file downloaded for your records.`);
            }
        }

        function resetAllLocalStorage() {
            if (!confirm('Clear all stored data for the WHITE Cell? This cannot be undone.')) return;

            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (/^(whiteCell|blueMove|greenMove|redMove)/i.test(key)) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));

            timelineItems = [];
            updateTimeline();
            updateBadges();
            timerSeconds = 90 * 60;
            updateTimer();
            currentPhase = 1;
            document.querySelectorAll('.phase-btn').forEach(btn => {
                const isActive = parseInt(btn.getAttribute('data-phase')) === currentPhase;
                btn.classList.toggle('active', isActive);
            });
            updatePhaseGuidance();
            document.getElementById('moveSelector').value = '1';
            currentMove = 1;
            document.getElementById('moveEpoch').textContent = moveEpochs[currentMove];
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id && el.id !== 'moveSelector') el.value = '';
            });

            alert('All local data cleared. The page will now reload.');
            location.reload();
        }

        // Initialize
        updateTimer();
        updatePhaseGuidance();
        
        // Auto-refresh timeline data every 5 seconds
        setInterval(() => {
            if (document.getElementById('timeline').classList.contains('active')) {
                updateTimeline();
                updateBadges();
            }
        }, 5000);

        // Listen for storage changes for cross-window/tab updates
        window.addEventListener('storage', (e) => {
            if (e.key === '_timelineUpdate' && e.newValue) {
                try {
                    const broadcast = JSON.parse(e.newValue);
                    if (broadcast.moveNumber === currentMove) {
                        const item = {
                            ...broadcast.item,
                            team: broadcast.team
                        };
                        timelineItems.push(item);
                        updateTimeline();
                        updateBadges();
                    }
                } catch (err) {
                    console.error('Failed to parse timeline update:', err);
                }
            }
        });

        // Auto-refresh timeline data every 5 seconds
</body>
</html>
